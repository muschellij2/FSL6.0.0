<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>topup/ApplyTopupUsersGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">topup/ApplyTopupUsersGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./topup.html">Introduction</a></li><li><a href="./topup(2f)TopupUsersGuide.html">Topup Users Guide</a></li><li><a href="./topup(2f)ExampleTopupFollowedByApplytopup.html">Example Topup Followed By Applytopup</a></li><li><a href="./topup(2f)Faq.html">FAQ</a></li><li><a href="./topup(2f)TopupFurtherInformation.html">Topup Further Information</a></li><li><a href="./topup(2f)ApplytopupFurtherInformation.html">Applytopup Further Information</a></li></ol></div> <span class="anchor" id="line-5"></span>
<h1 id="Running_applytopup">Running applytopup</h1>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">In order to best understand how one needs to run <tt class="backtick">applytopup</tt> for a given set of data one must know the details of how <tt class="backtick">topup</tt> was run on those same data. We therefore refer you to the <a href="./topup(2f)ExampleTopupFollowedByApplytopup.html">documentation</a> for the sequential use of topup and applytopup. <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867">
<h1 id="List_of_parameters">List of parameters</h1>
<span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><ul><li>Parameters that specify/qualify input files <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--imain">--imain=filename1,filename2,...</a> <br>
Comma-separated list of names of files to be corrected. E.g. my_blipup_images,my_blipdown_images. Compulsory. <span class="anchor" id="line-14"></span></li><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--datain">--datain=filename</a> <br>
Name of text file with information about the acquisition of the images in <tt class="backtick">--imain</tt>. E.g. <tt class="backtick">my_parameters.txt</tt>. Compulsory. <span class="anchor" id="line-15"></span></li><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--inindex">--inindex=num,num,...</a> <br>
Comma-separated list of indicies into <tt class="backtick">--datain</tt> corresponding to the files given for <tt class="backtick">--imain</tt>. Compulsory. <span class="anchor" id="line-16"></span></li><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--topup">--topup=filename</a> <br>
The basename of the output from topup. Compulsory. <span class="anchor" id="line-17"></span><span class="anchor" id="line-18"></span></li><li class="gap">Parameters that specify output files <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--out">--out=filename</a> <br>
 Basename for output file (distortion corrected images). Compulsory. <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span></li><li class="gap">Parameters that affect how the output is generated <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--method">--method=jac/slr</a> <br>
 Method to use for resampling of images. Default is <tt class="backtick">slr</tt>. <span class="anchor" id="line-25"></span></li><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--interp">--interp=trilinear/spline</a> <br>
 Method to use for interpolation of images. Only applies when <tt class="backtick">--method=jac</tt>. Default is <tt class="backtick">spline</tt>. <span class="anchor" id="line-26"></span></li><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)ApplyTopupUsersGuide.html#A--datatype">--datatype=char/short/int/float/double</a> <br>
 Force output image to be of certain data type. Default is same as input image. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></li></ul><p class="line867">
<h1 id="Parameters_explained">Parameters explained</h1>
<span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line867">
<h2 id="A--imain">--imain</h2>
<span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line874">List of files with images that you want to correct. This will not be the same file as you used as input to topup. For topup you needed to put your different acquisitions in the same file, whereas for applytopup you need to keep them separate. A typical use would be <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line874">applytopup --imain=my_blipup,my_blipdown --datain=my_parameters --inindex=1,2 --topup=my_field --out=my_good_images <span class="anchor" id="line-35"></span>where my_blipup is a 4D file containing volumes acquired with positive phase-encode blips and my_blipdown contains volumes acquired with negative blips. The resulting undistorted file will be a combination of the two input volumes, where the details of that combination depends on the --method parameter. Hence, the two files must contain data that is identical save for the acquisition parameters. If e.g. my_blipup consists of a b0 volume followed by three dwis with diffusion gradients [1 0 0], [0 1 0] and [0 0 1], then my_blipdown must contain a b0 volume followed by dwis corresponding to [1 0 0], [0 1 0] and [0 0 1]. The output (my_good_images) will then contain a single copy of a b0 followed by [1 0 0], [0 1 0] and [0 0 1] dwis. <span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><p class="line874">When using --method=jac it is in principle possible to generate one unwarped volume per input volue. However, all files specified together for --imain will be combined into a single output file. If one would want separate distortion corrected images (e.g. if one has scanned different sets of diffusion gradients for the two acquisitions) one can obtain that by <span class="anchor" id="line-38"></span>applytopup --imain=my_blipup --datain=my_parameters --inindex=1 --topup=my_field --method=jac --out=my_good_blipup_images <span class="anchor" id="line-39"></span>applytopup --imain=my_blipdown --datain=my_parameters --inindex=2 --topup=my_field --method=jac --out=my_good_blipdown_images <span class="anchor" id="line-40"></span>If one specifies more than two input files they will all be combined into a single output file. Let us say e.g. one has acquired two repeats with blipup and one repeat with blipdown one can run <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><p class="line874">applytopup --imain=my_blipup1,my_blipup2,my_blipdown --datain=my_parameters --inindex=1,2,3 --topup=my_field --out=my_good_images <span class="anchor" id="line-43"></span>in which case my_good_images will represent a combination of all three inputs. <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line867">
<h2 id="A--datain">--datain</h2>
<span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line874">This is a text-file containing information about the acquisition parameters for the images. For all cases I can think of this will be identical to the file given as input to topup. <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line867">
<h2 id="A--inindex">--inindex</h2>
<span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line874">This is a slightly tricky parameter to understand, and one where I suspect I will be doing a lot of explaining/helping. <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line874">It consists of a set of indicies like e.g. --inindex=1,3. The order of these corresponds to the order in which the files to --imain are specified, and their values correspond to the rows in the --datain and --topup files. I think the easiest way to explain it is with an example. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line874">Let us say you have collected data according to the fmrib 29-31 protocol. It consists of two acquisitions, one with 1 b0 volume followed by 29 different dwis. The second acquisition also starts with a b0 volume, followed by 31 different dwis. The 29+31 dwis together constitute 60 unique directions sampled uniformly(ish) on the whole-sphere. Let us further assume that the full protocol has been repeated once for blip-up and once for blip-down acquisition and that the files are named fmrib29_bup, fmrib31_bup, fmrib29_bdn, fmrib31_bdn respectively. <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line874">To correct these we would start by extracting all b0 files and collecting them in a single file. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line874">fslroi fmrib29_bup b0_1_bup 0 1 <span class="anchor" id="line-60"></span>fslroi fmrib31_bup b0_2_bup 0 1 <span class="anchor" id="line-61"></span>fslroi fmrib29_bdn b0_1_bdn 0 1 <span class="anchor" id="line-62"></span>fslroi fmrib31_bdn b0_2_bdn 0 1 <span class="anchor" id="line-63"></span>fslmerge -t all_my_b0 b0_1_bup b0_2_bup b0_1_bdn b0_2_bdn <span class="anchor" id="line-64"></span>and by creating a --datain file named my_acqu_para.txt containing <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><p class="line874">0 1 0 0.087 <span class="anchor" id="line-67"></span>0 1 0 0.087 <span class="anchor" id="line-68"></span>0 -1 0 0.087 <span class="anchor" id="line-69"></span>0 -1 0 0.087 <span class="anchor" id="line-70"></span>We are now ready to run topup with a command like <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line874">topup --imain=all_my_b0 --datatin=my_acqu_para.txt --config=my_nifty_parameters --out=my_topup_output <span class="anchor" id="line-73"></span>This will generate two output files, one .nii file called my_topup_output.nii containing spline coefficients defining the field and a text file called my_topup_output.txt containig 4 sets of movement parameters, one for each volume in all_my_b0 <span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><p class="line874">0 0 0 0 0 0 <span class="anchor" id="line-76"></span>-0.0323452 0 -0.131612 -5.99714e-05 -0.00182856 -0.000162457 <span class="anchor" id="line-77"></span>0.391246 0 -0.514049 -0.00478399 -0.00929278 0.00235141 <span class="anchor" id="line-78"></span>0.402124 0 -0.531344 -0.00554897 -0.00924577 0.00213802 <span class="anchor" id="line-79"></span>These are now used to correct for distortions (and movement between the b0 images) using <span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><p class="line874">applytopup --imain=fmrib29_bup,fmrib29_bdn --datain=my_acqu_para.txt --inindex=1,3 --topup=my_topup_output --out=fmrib29_hifi <span class="anchor" id="line-82"></span>applytopup --imain=fmrib31_bup,fmrib31_bdn --datain=my_acqu_para.txt --inindex=2,4 --topup=my_topup_output --out=fmrib31_hifi <span class="anchor" id="line-83"></span>Note how the file fmrib29_bup is given an index 1, that is used to index the row 0 1 0 0.087 in my_acqu_para.txt and the row 0 0 0 0 0 0 in my_topup_output.txt. Equivalently fmrib29_bdn has the index 3, indexing the row 0 -11 0 0.087 in my_acqu_para.txt and the row 0.391246 0 -0.514049 -0.00478399 -0.00929278 0.00235141 in my_topup_output.txt. Note also that the first applytopup command above could equivalently have been written <span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><p class="line874">applytopup --imain=fmrib29_bdn,fmrib29_bup --datain=my_acqu_para.txt --inindex=3,1 --topup=my_topup_output --out=fmrib29_hifi <span class="anchor" id="line-86"></span>Note also that we could NOT have used <span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line874">applytopup --imain=fmrib29_bup,fmrib29_bdn,fmrib31_bup,fmrib31_bdn --datain=my_acqu_para.txt --inindex=1,3,2,4 --topup=my_topup_output --out=fmrib_anything_but_hifi <span class="anchor" id="line-89"></span>since that would have led to averaging across data acquired with different diffusion gradients. I repeat, the above it NOT valid. <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><p class="line867">
<h2 id="A--topup">--topup</h2>
<span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><p class="line874">This should be the basename that was given for the --out parameters when running topup. Given --topup=my_filename, --applytopup will assume the existence of my_filename.nii (or my_filename.nii.gz) and my_filename.txt and use these. Back to list of parameters <span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><p class="line867">
<h2 id="A--out">--out</h2>
<span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><p class="line874">This will be the (base)name of the corrected output images. Note that there will always only be one output file regardless of the number of input (--imain) files. If one wants separate output files for the different inputs. So e.g. <span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><p class="line874">applytopup --imain=blip_up,blip_down --datain=my_para,txt --inindex=1,2 --topup=my_topup_output --method=jac --out=my_hifi_images <span class="anchor" id="line-100"></span>will produce a single output whereas <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><p class="line874">applytopup --imain=blip_up --datain=my_para,txt --inindex=1 --topup=my_topup_output --method=jac --out=my_hifi_blipup_images <span class="anchor" id="line-103"></span>applytopup --imain=blip_down --datain=my_para,txt --inindex=2 --topup=my_topup_output --method=jac --out=my_hifi_blipdown_images <span class="anchor" id="line-104"></span>will produce two separate files. <span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span><p class="line867">
<h2 id="A--method">--method</h2>
<span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span><p class="line874">This parameter decides which of the two resampling methods to use. If --method=jac is used there will be a kernel based interpolation described below. If --method=lsr is used a voxel-specific kernel will be estimated and used to deduce a single interpolated value from the data from both (or more) input volumes. N.B. that this voxel-specific kernel will have negative lobes and it can therefore introduce negative values even when given input that has all positive values. Therefore if ones subsequent analysis methods/software assume positive values one should use something like fslmaths my_splinterpolated_images -abs my_positive_splinterpolated_images before proceeding. <span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span><p class="line867">
<h2 id="A--interp">--interp</h2>
<span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span><p class="line862">When using --method=jac and the transform x-&gt;x' maps to a point that is not on a voxel centre in the --in volume, the pertinent intensity value will have to be deduced from the intensities at the surrounding voxel centres. This process is known as interpolation. In applytopup there are two choices, tri-linear interpolation of cubic B-spline interpolations. In general, spline interpolation is more accurate at the cost of slightly longer execution time. I would strongly recommend spline interpolations, and hence it is the default. <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span><p class="line874">N.B. that spline interpolation can introduce negative values even when given input that has all positive values. Therefore if ones subsequent analysis methods/software assume positive values one should use something like fslmaths my_splinterpolated_images -abs my_positive_splinterpolated_images before proceeding. <span class="anchor" id="line-115"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:30
</body>
</html>
