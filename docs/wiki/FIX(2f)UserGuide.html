<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FIX/UserGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FIX/UserGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./FIX.html">Introduction</a></li><li>User Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Downloading_and_Installing_FIX">Downloading and Installing FIX</a></li><li>
<a href="#Running_FIX">Running FIX</a><ol><li>
<a href="#Simple_usage.2C_assuming_training_data_already_exists:">Simple usage, assuming training data already exists:</a></li><li>
<a href="#Usage_for_each_stage_separately:">Usage for each stage separately:</a></li><li>
<a href="#Training_datasets">Training datasets</a><ol><li>
<a href="#Trained-weights_files">Trained-weights files</a></li><li>
<a href="#How_to_create_and_use_a_new_trained-weights_file">How to create and use a new trained-weights file</a></li></ol></li><li>
<a href="#Input_files_required_-_in_more_detail">Input files required - in more detail</a></li></ol></li></ol></div></div></li><li><a href="./FIX(2f)FAQ.html">FAQ</a></li></ol></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
<h1 id="Downloading_and_Installing_FIX">Downloading and Installing FIX</h1>
<span class="anchor" id="line-4"></span><p class="line874">Requirements: <span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span><ul><li><p class="line891"><a class="http" href="http://www.fmrib.ox.ac.uk/fsl">FSL</a> <span class="anchor" id="line-7"></span></li><li>MATLAB (though see above), with official toolboxes: <span class="anchor" id="line-8"></span><ul><li>Statistics <span class="anchor" id="line-9"></span></li><li>Signal Processing <span class="anchor" id="line-10"></span></li></ul></li><li><p class="line891"><a class="http" href="http://www.r-project.org/">R</a> free statistics software <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span></li></ul><p class="line874">Setup FIX: <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><ul><li><p class="line862">Unpack <a class="http" href="http://www.fmrib.ox.ac.uk/~steve/ftp/fix.tar.gz">FIX</a> with <tt>tar&nbsp;xvfz&nbsp;fix.tar.gz</tt> (or <tt>tar&nbsp;xvf&nbsp;fix.tar</tt> if your browser has already uncompressed the file). <span class="anchor" id="line-15"></span></li><li><p class="line862">See the <tt>README</tt> file for further setup instructions <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span></li></ul><p class="line867">
<h1 id="Running_FIX">Running FIX</h1>
<span class="anchor" id="line-18"></span><p class="line867">
<h2 id="Simple_usage.2C_assuming_training_data_already_exists:">Simple usage, assuming training data already exists:</h2>
<span class="anchor" id="line-19"></span><p class="line874">To run use the script &quot;fix&quot; in the FIX directory, e.g.: <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line867"><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><pre><span class="anchor" id="line-1"></span>/usr/local/fix/fix &lt;mel.ica&gt; /usr/local/fix/training_files/Standard.RData  20</pre><span class="anchor" id="line-24"></span><p class="line862">You need to feed in a full &quot;first-level&quot; (single-session) output directory (&lt;mel.ica&gt;) created by the MELODIC or FEAT GUIs, with full registration run, including using a structural. If using FEAT, you need to have had ICA turned on in the <tt>Prestats</tt>.  For the single-subject ICA you should in general use MELODIC's automatic dimensionality estimation (which creates the sub-folder &lt;mel.ica&gt;/filtered_func_data.ica). The <tt>20</tt> refers to the thresholding of good vs bad components; sensible values are generally in the range of 5-20. However, if it is very important to you that almost no good components are removed, and hence you would prefer to leave in the data a larger number of bad components, then use a low threshold (e.g., in the range 1-5). It is strongly recommended that you look at the ICA components yourself to check at least a few of your subjects' classifications - look in the file called something like fix4melview_Standard_thr20.txt - the final line lists the components that are considered as noise to be removed (with counting starting at 1 not 0). When running fix as shown above, you will end up with a cleaned version of the 4D preprocessed FMRI data: <tt>filtered_func_data_clean.nii.gz</tt>. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line862">If you have a compute cluster you can send the whole command to the cluster by preceding it with something like <tt>fsl_sub&nbsp;-q&nbsp;long.q&nbsp;...&nbsp;</tt>  However, if you are using fix to train the classifier and run leave-one-out testing (see 2.2.3), we recommend that you run fix locally, if your local computer is able to submit jobs to your cluster, as it will do this for you, parallelising the LOO, and greatly speeding it up). <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line867">
<h2 id="Usage_for_each_stage_separately:">Usage for each stage separately:</h2>
<span class="anchor" id="line-29"></span><p class="line874">The command described above is equivalent to run the following 3 steps: <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line874">Extract features (for later training and/or classifying). <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line867"><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><pre><span class="anchor" id="line-1-1"></span>/usr/local/fix/fix -f &lt;mel.ica&gt;</pre><span class="anchor" id="line-36"></span><p class="line862">Classify ICA components using a specific training dataset (&lt;thresh&gt; is in the range 0-100, typically 5-20). <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867"><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><pre><span class="anchor" id="line-1-2"></span>/usr/local/fix/fix -c &lt;mel.ica&gt; &lt;training.RData&gt; &lt;thresh&gt;</pre><span class="anchor" id="line-41"></span><p class="line874">Apply cleanup, using artefacts listed in the .txt file, to the data inside the enclosing Feat/Melodic directory. This text file can be the output from the step above or can be created manually, in case you want to manually remove the artefactual components. In the second case make sure that the txt file contains a single line (or, at least, should have as its final line) with a list of the bad components only, with the format (for example): [1, 4, 99, ... 140] - note that the square brackets, and use of commas, is required. Also, make sure there is an empty line at the end (i.e. hit return after writing the list). Counting starts at 1, not 0. <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line867"><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><pre><span class="anchor" id="line-1-3"></span>/usr/local/fix/fix -a &lt;mel.ica/fix4melview_TRAIN_thr.txt&gt;  [-m [-h &lt;highpass&gt;]]  [-A]</pre><span class="anchor" id="line-46"></span><ul><li style="list-style-type:none">-m : optionally also cleanup motion confounds, with highpass filtering of motion confounds controlled by: <span class="anchor" id="line-47"></span><ul><li style="list-style-type:none">- if -h is omitted, fix will look to see if a design.fsf file is present, to find the highpass cutoff. - if -h is omitted, and no design.fsf is present, no filtering of the motion confounds will take place. <span class="anchor" id="line-48"></span><p class="line862">- if -h &lt;highpass&gt; is set, then: <span class="anchor" id="line-49"></span><ul><li style="list-style-type:none">-h -1          apply no filtering to motion confounds. -h 0           apply linear detrending only. <span class="anchor" id="line-50"></span><p class="line862">-h &lt;highpass&gt;  with a positive &lt;highpass&gt; value, apply highpass with &lt;highpass&gt; being full-width (2*sigma) in seconds. <span class="anchor" id="line-51"></span></li></ul></li></ul>-A : apply aggressive (full variance) cleanup, instead of the default less-aggressive (unique variance) cleanup. <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span></li></ul><p class="line867">
<h2 id="Training_datasets">Training datasets</h2>
<span class="anchor" id="line-54"></span><p class="line867">
<h3 id="Trained-weights_files">Trained-weights files</h3>
<span class="anchor" id="line-55"></span><p class="line862">FIX needs to be trained from multiple datasets that have already had the ICA components classified into &quot;good&quot; and &quot;bad&quot; by hand. We have so far hand-trained a few different types of data, and the trained-weights files from these are supplied with FIX. If you want to train FIX yourself (which in general is recommended), to better optimise it for the kind of data you have, you will need to do this hand classification yourself (at <em>least</em> 10 subjects). Alternatively, you can use one of the trained-weights <tt>*.RData</tt> files supplied with FIX. <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line874">There are currently several trained-weights files supplied: <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><ul><li><p class="line891"><tt>Standard.RData</tt> - for use on more &quot;standard&quot; FMRI datasets / analyses; e.g., TR=3s, Resolution=3.5x3.5x3.5mm, Session=6mins, default FEAT preprocessing (including default spatial smoothing). <span class="anchor" id="line-60"></span></li><li><p class="line891"><tt>HCP_hp2000.RData</tt> for use on &quot;minimally-preprocessed&quot; HCP-like datasets, e.g., TR=0.7s, Resolution=2x2x2mm, Session=15mins, no spatial smoothing, minimal (2000s FWHM) highpass temporal filtering. <span class="anchor" id="line-61"></span></li><li><p class="line891"><tt>WhII_MB6.RData</tt> derived from the Whitehall imaging study, using multiband x6 EPI acceleration: TR=1.3s, Resolution=2x2x2mm, Session=10mins, no spatial smoothing, 100s FWHM highpass temporal filtering. <span class="anchor" id="line-62"></span></li><li><p class="line891"><tt>WhII_Standard.RData</tt> derived from more traditional early parallel scanning in the Whitehall imaging study, using no EPI acceleration: TR=3s, Resolution=3x3x3mm, Session=10mins, no spatial smoothing, 100s FWHM highpass temporal filtering. <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span></li></ul><p class="line862">You can find example training-input data, including our hand-labellings, <a class="http" href="http://www.fmrib.ox.ac.uk/analysis/FIX-training">here</a> (note that you do not need this example training-input data in order to run FIX; you just need the trained-weights files included in the FIX directory). <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><p class="line867">
<h3 id="How_to_create_and_use_a_new_trained-weights_file">How to create and use a new trained-weights file</h3>
<span class="anchor" id="line-67"></span><p class="line862">To do your own training, for each FEAT/MELODIC output directory, you will need to create a hand_labels_noise.txt file in the output directory. This text file should contain a single line (or, at least, should have as its final line), a list of the bad components only, with the format (for example): [1, 4, 99, ... 140] - note that the square brackets, and use of commas, is required. Counting starts at 1, not 0. Once you have created all of the hand label files, you can then train the classifier (creating the trained-weights file &lt;Training&gt;.RData) using the -t option: <span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><p class="line867"><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><pre><span class="anchor" id="line-1-4"></span>/usr/local/fix/fix -t &lt;Training&gt; [-l]  &lt;Melodic1.ica&gt; &lt;Melodic2.ica&gt; ...</pre><span class="anchor" id="line-72"></span><p class="line874">If you include the -l option after the trained-weights output filename, a full leave-one-out test will be run; the results file that gets created at the end has a set of numbers at the end of it that tell you the true-positive-rate (TPR, proportion of &quot;good&quot; components correctly labelled) and the true-negative-rate (TNR, proportion of &quot;bad&quot; components correctly labelled) for a wide range of thresholds (see higher up in the output file for the list of thresholds tested). <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line874">The output from this command are: Training.RData - the your new trained-weights file to be used for subsequent classification Training - a folder with a copy of the labels and the features of the subjects used to build the training dataset Traning_LOO - a folder containing the intermediate files for the leave-one-out test (if you used the -l option) Traning_LOO_results - a file with the results of the leave-one-out test (if you used the -l option) <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">You can now use your new trained-weights file to classify components in new datasets and then run the cleanup on the new data (see 2.2.2.): <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line862">/usr/local/fix/fix -c &lt;Melodic-output.ica&gt; &lt;Training.RData&gt; &lt;thresh&gt; <span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line862">/usr/local/fix/fix -a &lt;mel.ica/fix4melview_TRAIN_thr.txt&gt;  [-m [-h &lt;highpass&gt;]]  [-A]  [-x &lt;confound&gt;] [-x &lt;confound2&gt;] <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line874">If you want to test the accuracy of an existing training dataset on a set of hand-labelled subjects (e.g. to test whether an existing trained-weights file is suitable to be used for your study or if it’s better to create a new one), you can run the following command: <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line867"><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><pre><span class="anchor" id="line-1-5"></span>/usr/local/fix/fix -C &lt;training.RData&gt; &lt;output&gt; &lt;mel1.ica&gt; &lt;mel2.ica&gt; ...</pre><span class="anchor" id="line-87"></span><p class="line874">which classifies the components for all listed Melodic directories over a range of thresholds and produce LOO-style accuracy testing using existing hand classifications. Every Melodic directory must contain hand_labels_noise.txt listing the artefact components, e.g.:  [1, 4, 99, ... 140]. <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><p class="line867">
<h2 id="Input_files_required_-_in_more_detail">Input files required - in more detail</h2>
<span class="anchor" id="line-90"></span><p class="line874">If you haven't done the full GUI-based MELODIC/FEAT analysis, you will need, in one directory: <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><p class="line867"><span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><pre><span class="anchor" id="line-1-6"></span>  filtered_func_data.nii.gz          preprocessed 4D data
<span class="anchor" id="line-2"></span>  filtered_func_data.ica             melodic (command-line program) full output directory
<span class="anchor" id="line-3"></span>  mc/prefiltered_func_data_mcf.par   motion parameters created by mcflirt (in mc subdirectory)
<span class="anchor" id="line-4"></span>  mask.nii.gz                        valid mask relating to the 4D data
<span class="anchor" id="line-5"></span>  mean_func.nii.gz                   temporal mean of 4D data
<span class="anchor" id="line-6"></span>  reg/example_func.nii.gz            example image from 4D data
<span class="anchor" id="line-7"></span>  reg/highres.nii.gz                 brain-extracted structural
<span class="anchor" id="line-8"></span>  reg/highres2example_func.mat       FLIRT transform from structural to functional space
<span class="anchor" id="line-9"></span>  design.fsf                         FEAT/MELODIC setup file; if present, this controls the
<span class="anchor" id="line-10"></span>                                       default temporal filtering of motion parameters</pre><span class="anchor" id="line-104"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:28
</body>
</html>
