<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>topup/TopupUsersGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">topup/TopupUsersGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./topup.html">Introduction</a></li><li>Topup Users Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Running_topup">Running topup</a></li><li>
<a href="#Life_after_topup_--_applytopup">Life after topup -- applytopup</a></li><li>
<a href="#Configuration_files">Configuration files</a></li><li>
<a href="#List_of_parameters">List of parameters</a></li><li>
<a href="#Selected_parameters_explained">Selected parameters explained</a><ol><li>
<a href="#A--imain">--imain</a></li><li>
<a href="#A--datain">--datain</a></li><li>
<a href="#A--out">--out</a></li><li>
<a href="#A--fout">--fout</a></li><li>
<a href="#A--iout">--iout</a></li><li>
<a href="#A--subsamp">--subsamp</a></li><li>
<a href="#A--warpres">--warpres</a></li><li>
<a href="#A--miter">--miter</a></li><li>
<a href="#A--fwhm">--fwhm</a></li><li>
<a href="#A--lambda">--lambda</a></li><li>
<a href="#A--estmov">--estmov</a></li><li>
<a href="#A--minmet">--minmet</a></li><li>
<a href="#A--ssqlambda">--ssqlambda</a></li><li>
<a href="#A--regmod">--regmod</a></li><li>
<a href="#A--splineorder">--splineorder</a></li><li>
<a href="#A--numprec">--numprec</a></li><li>
<a href="#A--interp">--interp</a></li><li>
<a href="#A--scale">--scale</a></li><li>
<a href="#A--regrid">--regrid</a></li></ol></li></ol></div></div></li><li><a href="./topup(2f)ExampleTopupFollowedByApplytopup.html">Example Topup Followed By Applytopup</a></li><li><a href="./topup(2f)Faq.html">FAQ</a></li><li><a href="./topup(2f)TopupFurtherInformation.html">Topup Further Information</a></li><li><a href="./topup(2f)ApplytopupFurtherInformation.html">Applytopup Further Information</a></li></ol></div> <span class="anchor" id="line-6"></span>
<h1 id="Running_topup">Running topup</h1>
<span class="anchor" id="line-7"></span><p class="line862">A call to <tt class="backtick">topup</tt> will typically look something like <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=all_my_b0_images.nii</tt> <a href="./topup(2f)TopupUsersGuide.html#A--datain">--datain</a><tt class="backtick">=acquisition_parameters.txt</tt> <a href="./topup(2f)TopupUsersGuide.html#Configuration_files">--config</a><tt class="backtick">=b02b0.cnf&nbsp;--out=my_output</tt> <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line862">where <tt class="backtick">all_my_b0_images.nii</tt> is a 4D image file containing all the data I want to use for the estimation of the field. Typically this will contain two, or more, b=0 volumes that have been acquired in slightly different ways so that translation off-resonance field-&gt;distortions is different in the different volumes. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span><p class="line867"><img align="top" alt="original_images.png" class="attachment" src="attachments/topup(2f)TopupUsersGuide/original_images.png" title="original_images.png" width="800" /> <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line862">Above you can see a selected slice from the four volumes in an example file called <tt class="backtick">my_b0_images.nii.gz</tt>. It is immediately obvious that the distortions in the first two images are vastly different from those in the two last images. If we take a look at the associated <tt class="backtick">acqparams.txt</tt> file <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line867"><tt class="backtick">0&nbsp;-1&nbsp;0&nbsp;0.062</tt><br>
 <span class="anchor" id="line-18"></span><tt class="backtick">0&nbsp;-1&nbsp;0&nbsp;0.062</tt><br>
 <span class="anchor" id="line-19"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.062</tt><br>
 <span class="anchor" id="line-20"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.062</tt> <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line862">we can see why. The two first images have been acquired with negative phase-encode blips in the <em>y</em>-direction, which means that signal from an area with &quot;higher than expected&quot; field (such as just above the ear-canals) will be displaced downwards. Conversely the two last images have been acquired with positive blips which means that signal from those same areas would be displaced upwards. <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line874">In addition to that we can see that the second image looks a little bit different to the first, despite having been acquired with identical parameters. This may mean that the subject moved between the acquisitions of the two images. <span class="anchor" id="line-25"></span><span class="anchor" id="line-26"></span><p class="line862">Let us now run <tt class="backtick">topup</tt>. We will use the command <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=acqparams.txt&nbsp;--config=b02b0.cnf&nbsp;--out=my_topup_results&nbsp;--fout=my_field&nbsp;--iout=my_unwarped_images</tt> <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span><p class="line862">Here we have asked for a little bit more detailed output by specifying also <a href="./topup(2f)TopupUsersGuide.html#A--fout">--fout</a> and <a href="./topup(2f)TopupUsersGuide.html#A--iout">--iout</a>. One would normally be content with just the <a href="./topup(2f)TopupUsersGuide.html#A--out">--out</a> output, but for pedagogical reasons we will look also at the other output for this demonstration run. <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><p class="line862">So, let us first take a look at <tt class="backtick">my_unwarped_images.nii.gz</tt> to see if <tt class="backtick">topup</tt> has done a decent job at correcting the distortions.  <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span><p class="line867"><img align="top" alt="hifi_images.png" class="attachment" src="attachments/topup(2f)TopupUsersGuide/hifi_images.png" title="hifi_images.png" width="800" /> <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><p class="line862">I think we can agree that that looks quite good and that we have no reason to think that <tt class="backtick">topup</tt> ran into any problems. Let us now look at <tt class="backtick">my_topup_results_movpar.txt</tt> to see if we were right in our suspicion that there had been some movement. <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><p class="line867"><tt class="backtick">0&nbsp;&nbsp;0&nbsp;&nbsp;0&nbsp;&nbsp;0&nbsp;&nbsp;0&nbsp;&nbsp;0</tt><br>
 <span class="anchor" id="line-39"></span><tt class="backtick">-0.073237&nbsp;&nbsp;0.025761&nbsp;&nbsp;-0.046236&nbsp;&nbsp;-0.088544&nbsp;&nbsp;-0.00099632&nbsp;&nbsp;0.0020353</tt><br>
 <span class="anchor" id="line-40"></span><tt class="backtick">-0.131236&nbsp;&nbsp;0&nbsp;&nbsp;-0.153924&nbsp;&nbsp;0.000365648&nbsp;&nbsp;-0.00146637&nbsp;&nbsp;-0.000709675</tt><br>
 <span class="anchor" id="line-41"></span><tt class="backtick">-0.147020&nbsp;&nbsp;0.284489&nbsp;&nbsp;-0.16171&nbsp;&nbsp;-0.00209923&nbsp;&nbsp;-0.00193369&nbsp;&nbsp;-0.000452118</tt><br>
 <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line862">In order to fully understand this file you need to have a look at the full <a href="./topup(2f)TopupUsersGuide.html#A--out">description</a> but for now we just focus on the second row (corresponding to the second volume in <tt class="backtick">my_b0_images.nii.gz</tt>) and the fourth column (corresponding to rotation (in radians) around the <em>x</em>-axis). We see there a value of -0.089, which corresponds to a five degrees rotation. So it seems we were right in our suspicion. <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line862">We next take a look at <tt class="backtick">my_field</tt> (the output from <tt class="backtick">--fout</tt>) to see what <tt class="backtick">topup</tt> thinks the off-resonance field looks like. <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line867"><img align="top" alt="field_images.png" class="attachment" src="attachments/topup(2f)TopupUsersGuide/field_images.png" title="field_images.png" width="200" /> <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line874">which has been scaled so that black corresponds to -50Hz and white to 150Hz. This looks like a reasonable off-resonance field with higher than &quot;expected&quot; field above the ear-canals and the roof of the sinuses. <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line862">Finally we will take a look at how <tt class="backtick">topup</tt> stores this field by looking at <tt class="backtick">my_topup_results_fieldcoef.nii.gz</tt>. <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line867"><img align="top" alt="fieldcoef_images.png" class="attachment" src="attachments/topup(2f)TopupUsersGuide/fieldcoef_images.png" title="fieldcoef_images.png" width="200" /> <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line862">We see that while instantly recognisable it is not identical to the field image. It is the weights/coefficients of a spline-representation of the field, which means that to get from the &quot;fieldcoef&quot; image to the field image one needs to convolve the former with a spline kernel. The reason <tt class="backtick">topup</tt> stores it as spline coefficients is because it saves space and also gives immediate access to a continuous representation of the field. <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line867">
<h1 id="Life_after_topup_--_applytopup">Life after topup -- applytopup</h1>
<span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line862">The typical use of <tt class="backtick">topup</tt> is to use a pair, or a smallish number of pairs to estimate a susceptibility-induced off-resonance field, and then apply that to (i.e. use it to unwarp) a larger set of pairs. Typically the image volumes in <tt class="backtick">--imain</tt> will be a set of b=0 scans taken from a larger set of b=0 and diffusion weighted images. The resulting field will then be applied to all images, i.e. the b=0 and diffusion weighted images alike. The tool for applying the output of <tt class="backtick">topup</tt> to some larger/other set of images is <a href="./topup(2f)ApplyTopupUsersGuide.html">applytopup</a>. <span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><p class="line867">
<h1 id="Configuration_files">Configuration files</h1>
<span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><p class="line862">A configuration file is a text file containing some or all of the parameters that can be specified for topup. The name of the file should be passed as argument to the <tt class="backtick">--config</tt> parameter. It should be an ascii-file with one row for each parameter, and where comments (ignored by topup) are preceeded by a #.  <span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line862">A very simple (and silly) config file named <tt class="backtick">my_silly_file.cnf</tt> could look like <span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><p class="line867"><tt class="backtick">#&nbsp;I&nbsp;want&nbsp;to&nbsp;use&nbsp;membrane&nbsp;energy&nbsp;for&nbsp;regularisation</tt> <span class="anchor" id="line-68"></span><tt class="backtick">--regmod=membrane_energy</tt> <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line874">It becomes more useful when it specifes all or most parameters with values suited for ones particular application. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line874">When a parameter is specified both in the config-file and on the command line, the value on the command line takes precedence. For example with the example above we could run topup with <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=blip_up,blip_down&nbsp;--datain=blips_up_and_down.txt&nbsp;--config=my_silly_file&nbsp;--regmod=bending_energy</tt> <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line862">and the <tt class="backtick">--regmod=bending_energy</tt> on the command line will take precedence over the specification in <tt class="backtick">my_silly_file</tt>. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line862">When you specify <tt class="backtick">--config=my_file</tt>, i.e. without explicit path or extension, fnirt will search for <tt class="backtick">./my_file</tt>, <tt class="backtick">./my_file.cnf</tt>, <tt class="backtick">${FSLDIR}/etc/flirtsch/my_file</tt> and <tt class="backtick">${FSLDIR}/etc/flirtsch/my_file.cnf</tt> in that order and use the first one that is found. <span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line862">As part of the topup distribution we supply a predefined config file: <tt class="backtick">b02b0.cnf</tt>. It contains parameters that have been found to be useful for registering a set of good quality b=0 images. Together with the override facility this is probably the starting (an quite possible finishing) point for most users. Note that <tt class="backtick">b02b0.cnf</tt> uses sub-sampling to speed up the estimation and that <tt class="backtick">topup</tt> requires that the image-size is a multiple of the sub-sampling level. So, for example if you want to use sub-sampling by a factor of 2 the image-size should be a multiple of 2 in all directions (<em>e.g.</em> 96x96x48). <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line874">If you have an application for which you think the predefined config file isn't appropriate you may want to read about the individual parameters below and write your own file. We would then recommend to start with the predefined file and gradually change it to suit your particular requirements. <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><p class="line867">
<h1 id="List_of_parameters">List of parameters</h1>
<span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><ul><li>Parameters that specify input files <span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--imain">--imain=filename</a> <br>
 Name of a file with input images optained with different PE polarity/direction. E.g. <tt class="backtick">my_b0_images.nii</tt>. <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--datain">--datain=filename</a> <br>
 Name of text file with information about the acquisition of the images in <tt class="backtick">--imain</tt>. E.g. <tt class="backtick">my_parameters.txt</tt> <span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#Configuration_files">--config=config_file</a> <br>
 Name of text-file with parameter settings. If you read about nothing else, read about this. <span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span></li></ul></li><li class="gap">Parameters specifying names of output-files <span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--out">--out=filename</a> <br>
 Name of output-files containing the spline coefficients for the off-resonance field and the subject movement parameters. <span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--fout">--fout=filename</a> <br>
 Name of output-file containing the off-resonance field. <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--iout">--iout=filename</a> <br>
 Name of output-file containing unwarped images. <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--logout">--logout=filename</a> <br>
 Name of output-file containing the log. <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span></li></ul></li><li class="gap">Parameters specified once per resolution/subsampling level <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--subsamp">--subsamp=level1,level2,...</a> <br>
 Levels of sub-sampling for which to perform the registration. E.g. <tt class="backtick">4,2,1</tt> <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--fwhm">--fwhm=level1,level2,...</a> <br>
 Amount of smoothing to apply to images for each level. E.g. <tt class="backtick">8,4,0</tt> <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--miter">--miter=level1,level2,...</a> <br>
 Number of iterations to run for each level. E.g. <tt class="backtick">5,5,10</tt> <span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--lambda">--lambda=level1,level2,...</a> <br>
 Relative weight between sum-of-squared differences and regularisation for each level. E.g. <tt class="backtick">300,75,30</tt> <span class="anchor" id="line-114"></span><span class="anchor" id="line-115"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--estmov">--estmov=level1,level2,...</a> <br>
 Determines wether to estimate or keep movement parameters constant for a given level. 1 means estimate and 0 means keep fixed. E.g. <tt class="backtick">1,1,0</tt> <span class="anchor" id="line-116"></span><span class="anchor" id="line-117"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--minmet">--minmet=level1,level2,...</a> <br>
 Specifies what minimisation method to use for each level. 0 means Gauss-Newton and 1 means Scaled Conjugate Gradient. E.g. <tt class="backtick">0,0,1</tt> <span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span></li></ul></li><li class="gap">Parameters specified once and for all <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--ssqlambda">--ssqlambda=0/1</a> <br>
 If set to 1, implies that <tt class="backtick">--lambda</tt> should be multiplied by sum-of-squared differences. Default is 1. <span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--regmod">--regmod=model</a> <br>
 Specifies what regularisation-model should be used. E.g. <tt class="backtick">membrane_energy</tt>. Default is <tt class="backtick">bending_energy</tt> <span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--splineorder">--splineorder=num</a> <br>
 Order of B-spline (2/3). Default is 3. <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--numprec">--numprec=float/double</a> <br>
 Numerical precision for calculating and representing the Hessian. Default is <tt class="backtick">double</tt> <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--interp">--interp=linear/spline</a> <br>
 Interpolation model for deducing intensities when not on voxel centres. Default is <tt class="backtick">spline</tt> <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--scale">--scale=0/1</a> <br>
 If set to 1 the volumes in <tt class="backtick">--imain</tt> are scaled to a common mean. Default is 0. <span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><tt class="backtick">--verbose</tt> <br>
 Print progress information to the screen while running. Can be useful to pipe into file before reporting problems <span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><tt class="backtick">--help</tt> <br>
 Take a wild stab. <span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span></li></ul></li></ul><p class="line867">
<h1 id="Selected_parameters_explained">Selected parameters explained</h1>
<span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line867">
<h2 id="A--imain">--imain</h2>
<span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line862">The value for this parameter should be the name of an image file (typically .nii or .nii.gz) containing images acquired with different phase-encoding parameters. All types of images can be used to estimate the distortions, but the b0 images have the best SNR so it is often best to use those. Furthermore it is often the case that diffusion weighted images are also affected by eddy current (EC) induced distortions, which means that any off-resonance field estimated from a pair of dwis will include the EC component as well, making it specific to that field. <br>
  <span class="anchor" id="line-142"></span>Let us say you have acquired a bunch of b0 and dwi images using positive phase-encode blips in the 4D file <tt class="backtick">bup.nii</tt> and another bunch of b0 and dwi's acquired with negative PE blips in <tt class="backtick">tdn.nii</tt>. You would then start by extracting the images you want to use (e.g. the b0 images) using <tt class="backtick">fslroi</tt>. For example <tt class="backtick">fslroi&nbsp;bup&nbsp;b0_bup&nbsp;0&nbsp;3</tt> would extract the three first volumes (assuming these are the b0 images) from <tt class="backtick">bup.nii</tt>, putting them in <tt class="backtick">b0_bup.nii</tt>. After having done the same thing for <tt class="backtick">tdn.nii</tt> you can merge the two files using <tt class="backtick">fslmerge</tt>, e.g. <tt class="backtick">fslmerge&nbsp;-t&nbsp;b0&nbsp;b0_bup&nbsp;b0_bdn</tt> which will put all 6 b0 images in the same file (<tt class="backtick">b0.nii</tt>) with the three acquired with positive phase-encode blips first. <span class="anchor" id="line-143"></span><span class="anchor" id="line-144"></span><p class="line867">
<h2 id="A--datain">--datain</h2>
<span class="anchor" id="line-145"></span><span class="anchor" id="line-146"></span><p class="line862">This parameter specifies a text-file that contains information about how the volumes in <tt class="backtick">--imain</tt> were acquired. Let us use the file <tt class="backtick">b0.nii</tt> that we created above as an example. The file should in that case look like  <span class="anchor" id="line-147"></span><span class="anchor" id="line-148"></span><p class="line867"><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-149"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-150"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-151"></span><tt class="backtick">0&nbsp;-1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-152"></span><tt class="backtick">0&nbsp;-1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-153"></span><tt class="backtick">0&nbsp;-1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span><p class="line862">where the three first columns specify the direction of the phase-encoding. In these cases there is a non-zero value only in the second column, indicating that phase-encoding is performed in the <em>y</em>-direction (typically corresponding to the anterior-posterior direction). The three first rows have a (positive) 1 in the second position, meaning that positive phase-encode blips were used, followed by three rows with -1 signifying negative phase encode blips. The fourth column is the total readout time (defined as the time from the centre of the first echo to the centre of the last) in seconds.<br>
  <span class="anchor" id="line-156"></span>If your readout time is identical for all acquisitions you don't neccessarily have to specify a valid value in this column (you can e.g. just set it to 1), but if you do specify correct values the estimated field will be correctly scaled in Hz, which may be a useful sanity check. Also note that this value corresponds to the time you would have had had you collected all <em>k</em>-space lines. I.e. let us say you collect a 96x96 matrix with 1ms dwell-time (time between centres of consecutive echoes) and let us further say that you have opted for partial <em>k</em>-space (in order to reduce the echo time), collecting only 64 echoes. In this case the level of distortion will be identical to what it would have been had you collected all 96 echoes, and you should put 0.095 in the fourth column. <span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><p class="line874">Topup gives you lots of freedom in how to acquire your data and still be able to calculate and correct for distortions. You can e.g. use  <span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><p class="line867"><tt class="backtick">1&nbsp;0&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-161"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span><p class="line874">indicating that the first scan was acquired with phase-encoding in the left-right direction and the second in the anterior-posterior direction. One can even acquire ones data like  <span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span><p class="line867"><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.087</tt><br>
 <span class="anchor" id="line-166"></span><tt class="backtick">0&nbsp;1&nbsp;0&nbsp;0.107</tt><br>
 <span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span><p class="line862">i.e. with distortions going in the same direction in both acquisitions but with slightly larger distortions in one case (the latter in this example).<br>
 <span class="anchor" id="line-169"></span>Despite this flexibility it is nevertheless best to manipulate the phase-encoding so that it yields the maximum difference in the observed images, and that will a reversal of the blips. So unless one has a very good reason to do otherwise that is the recommended type of acquisition. <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span><p class="line867"><strong>N.B.</strong> that <tt class="backtick">topup</tt>'s definition of positive is simply given by increasing indicies into the image file and may or may not coincide with how a given scanner manufacturer has defined the positive direction for phase-encode blips. If both your acquisitions perform phase-encoding along the same axis, but with different signs/readout-times, topup will still be able to calculate and correct for the distortions, though the estimated off-resonance field may be sign reversed. However, if ones acquisitions have been performed with phase-encoding along different axes it is important to get the signs to correspond to the definition by your scanner manufacturer. I recommend simply trial and error to work it out. <span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span><p class="line867"><strong>N.B. 2</strong>, please do <strong>NOT</strong> confuse phase-encode direction and diffusion gradient direction. They are completely independent. <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span><p class="line867">
<h2 id="A--out">--out</h2>
<span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><p class="line862">The value for the <tt class="backtick">--out</tt> parameter is used as the basename for the output files produced by topup. Given a set of files, let us use the example in <tt class="backtick">--imain</tt> above, topup will estimate a field, that is common to all scans, and movement parameters for scans 2-<em>n</em>. The movement parameters will encode the positions of scans 2-<em>n</em> relative to scan 1. <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span><p class="line862">Hence, given <tt class="backtick">--out=my_out</tt>, topup will write two files, one image file containing spline coefficients encoding the field (named <tt class="backtick">my_out_fieldcoef.nii</tt> or <tt class="backtick">my_out_fieldcoef.nii.gz</tt> depending on the global FSL settings) and one text file named <tt class="backtick">my_out_movpar.txt</tt>. In the six scan example above the <tt class="backtick">.txt</tt> output was  <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span><p class="line867"><tt class="backtick">0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0</tt><br>
 <span class="anchor" id="line-182"></span><tt class="backtick">-0.0323452&nbsp;0.0257616&nbsp;-0.131612&nbsp;-5.99714e-05&nbsp;-0.00182856&nbsp;-0.000162457</tt><br>
 <span class="anchor" id="line-183"></span><tt class="backtick">-0.0244460&nbsp;0.2844895&nbsp;-0.129879&nbsp;-1.05641e-05&nbsp;-0.00173325&nbsp;-3.44437e-05</tt><br>
 <span class="anchor" id="line-184"></span><tt class="backtick">0.391246&nbsp;0&nbsp;-0.514049&nbsp;-0.00478399&nbsp;-0.00929278&nbsp;0.00235141</tt><br>
 <span class="anchor" id="line-185"></span><tt class="backtick">0.402124&nbsp;-0.131236&nbsp;-0.531344&nbsp;-0.00554897&nbsp;-0.00924577&nbsp;0.00213802</tt><br>
 <span class="anchor" id="line-186"></span><tt class="backtick">0.420413&nbsp;-0.147020&nbsp;-0.513022&nbsp;-0.00566367&nbsp;-0.00943247&nbsp;0.00218128</tt><br>
 <span class="anchor" id="line-187"></span><span class="anchor" id="line-188"></span><p class="line862">where we can notice that the first scan is represented by a row of zeros. The three first columns represent translations (mm) in the <em>x</em>-, <em>y</em>- and <em>z</em>-directions respectively and the next three columns represent rotations (radians) around the <em>x-</em>, <em>y</em>- and <em>z</em>-axes. Notice also that the second column has a zero for the fourth scan (the first scan with a different blip-direction). This is because the distortions go along this direction and there is no way to disambiguate a subject translation in this direction from an offset in the displacements constituting the distortions. <span class="anchor" id="line-189"></span><span class="anchor" id="line-190"></span><p class="line867"><strong>N.B.</strong> that there is no general non-ambigous way to encode a transformation matrix by a set of translations and rotations. Hence it would in general be a bad idea to use the values in the <tt class="backtick">.txt</tt> output from <tt class="backtick">--out</tt> to make your own transformation matrices (if for some reason you would need these). Instead you should use the tools that have been designed to work together with <tt class="backtick">topup</tt>: <tt class="backtick">applytopup</tt> and <tt class="backtick">eddy</tt>. <span class="anchor" id="line-191"></span><span class="anchor" id="line-192"></span><p class="line867">
<h2 id="A--fout">--fout</h2>
<span class="anchor" id="line-193"></span><span class="anchor" id="line-194"></span><p class="line862">Specifies the name of an image file containing the estimated field in Hz. The actual information is the same as that in the <tt class="backtick">*_fieldcoef.nii.gz</tt> file from the <tt class="backtick">--out</tt> parameter. They are different in that the <tt class="backtick">--fout</tt> image contains the actual voxel-values (as opposed to spline coefficients) which makes it easier to use with applications that cannot read the <tt class="backtick">topup</tt> output format. It is for example useful if you want to feed it as a fieldmap into FEAT. <span class="anchor" id="line-195"></span><span class="anchor" id="line-196"></span><p class="line867">
<h2 id="A--iout">--iout</h2>
<span class="anchor" id="line-197"></span><span class="anchor" id="line-198"></span><p class="line862">Specifies the name of a 4D image file that contains unwarped and movement corrected images. Each volume in the <tt class="backtick">--imain</tt> will have a corresponding corrected volume in <tt class="backtick">--iout</tt>. This output uses traditional interpolation and Jacobian modulation (see applytopup) and is used mainly as a sanity check that things have worked and that <tt class="backtick">topup</tt> has estimated a reasonable field. It can also be useful for making an undistorted mask for use in <a class="nonexistent" href="./eddy(2f)UsersGuide(2f).html#A--mask">eddy</a> by running <a href="./BET(2f)UserGuide.html">BET</a> on the first volume (or the average of all volumes) of the output. <span class="anchor" id="line-199"></span><span class="anchor" id="line-200"></span><p class="line867">
<h2 id="A--subsamp">--subsamp</h2>
<span class="anchor" id="line-201"></span><span class="anchor" id="line-202"></span><p class="line862">A multi-resolution approach is a way of avoiding local minima. It consists of sub-sampling, estimating the warps at the current scale, up-sample, estimating the warps at the next scale etc  The scheme for the multi resolution approach is given by the <tt class="backtick">--subsamp</tt> parameter. So for example <span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=my_acquisition_parameters&nbsp;--subsamp=4,2,1</tt> <span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span><p class="line874">means that data will be subsampled by a factor of 4 and the transform will be calculated at that level. It will the be subsampled by a factor of 2 (i.e. an upsampling compared to the previous step) and the warps will be estimated at that scale, with the warps from the first scale as a starting estimate. And finally this will be repeated at the full resolution (i.e. subsampling 1). <span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><p class="line862">The value of the <tt class="backtick">--subsamp</tt> parameter will determine the &quot;number of registrations&quot; that are performed as steps in the &quot;total&quot; registration. There are a number of other parameters that can the be set on a &quot;sub-registration&quot; or on a &quot;total registration&quot; basis. So for example <span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=my_acquisition_parameters&nbsp;--subsamp=4,2,1&nbsp;--fwhm=8,4,0</tt> <span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span><p class="line874">Means that you request three &quot;sub-registrations&quot; with sub-samplings 4, 2 and 1 respectively and that for the first registration you want the your images smoothed with an 8mm FWHM Gaussian filter, for the second with a 4mm filter and for the final step no smoothing at all. On the other hand <span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=my_acquisition_parameters&nbsp;--subsamp=4,2,1&nbsp;--fwhm=8</tt> <span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><p class="line874">means that you want the images smoothed to 8mm FWHM for all registration steps. These other parameters must either be specified once, and will then be applied to all sub-registrations, or as many times as there are sub-registraions. The parameters for which this is true are <span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span><ul><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--warpres">--warpres</a> <span class="anchor" id="line-219"></span></li><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--miter">--miter</a> <span class="anchor" id="line-220"></span></li><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--fwhm">--fwhm</a> <span class="anchor" id="line-221"></span></li><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--lambda">--lambda</a> <span class="anchor" id="line-222"></span></li><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--estmov">--estmov</a> <span class="anchor" id="line-223"></span></li><li><p class="line891"><a href="./topup(2f)TopupUsersGuide.html#A--minmet">--minmet</a> <span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span></li></ul><p class="line874">The sub-sampling steps have to be monotonously decreasing, but do not have to be unique. One may for example want to run all steps at the full resolution, but with decreasing amount of regularistaion, as an optional strategy for avoiding local minima. That can be done e.g. with a command like <span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=my_acquisition_parameters&nbsp;--subsamp=1,1,1&nbsp;--lambda=100,50,25</tt> <span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span><p class="line867">
<h2 id="A--warpres">--warpres</h2>
<span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><p class="line862">Specifies the resolution (in mm) of the warps. Specifying e.g. <tt class="backtick">--warpres=10</tt> means that an isotropic knot-spacing of 10mm is used for all levels of <tt class="backtick">--subsamp</tt>. If instead specifying e.g. <tt class="backtick">--warpres=10,5</tt> indicates that a (n isotropic) knot-spacing of 10mm should be used for the first level of <tt class="backtick">--subsamp</tt> followed by 5mm for the second level. A warp resolution of e.g. 10mm does not imply that 10mm is the highest accuracy that can be obtained for registration of any given structure. It is rather related to how fast the field can change as on goes from one point to the next in the field. The warps/field are implemented as cubic/quadratic <em>B</em>-splines with a knot-spacing that has to be an integer multiple of the voxel-size of the <tt class="backtick">--imain</tt> images. If a value is specified for <tt class="backtick">--warpres</tt> that is not and integer multiple the value will be rounded down. So if for example the voxel-size of the <tt class="backtick">--imain</tt> image is 3x3x4mm and <tt class="backtick">--warpes</tt> is specified as <tt class="backtick">--warpres=1</tt>0 the actual resolution (knot-spacing) of the warps will be 9x9x8mm. <span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><p class="line862">When running topup it is advantageous to go to a quite high warp-resolution, typically all the way to the voxel size (i.e. one spline per voxel). To achieve an actual knot-spacing of 1 voxel in all directions one should specify a knot-spacing smaller than two voxels in the direction with the smallest voxel size. If one e.g. has isotropic voxels with size 2.5x2.5x3.5mm, specifying <tt class="backtick">--warpres=4</tt> (4&lt;2*2.5) will give an actual knot-spacing of 2.5x2.5x3.5mm (i.e. 1x1x1voxels). <span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><p class="line862">Increasing the resolution means that topup will need more execution time and more memory. Most of the time and memory is spent on estimating and representing the Hessian. It may therefore be advantageous to swith to an alternative minimization method (i.e. Scaled Conjugate Gradient, specified by <tt class="backtick">--minmet=1</tt>) for the final high resolution steps. <span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><p class="line867">
<h2 id="A--miter">--miter</h2>
<span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span><p class="line862">Specifies the number of iterations that should be performed for each sub-registration. At present there is no proper convergence criterion implemented in <tt class="backtick">topup</tt>. Instead a fixed number of iterations is used for each step. <span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span><p class="line862">The two minimization methods implemented in topup calculates and uses quite different amounts of information at each iteration. As a rule of thumb Levenberg-Marquardt (<tt class="backtick">--minmet=0</tt>) uses relatively few, expensive, iterations whereas the Scaled Conjugate Gradient (<tt class="backtick">--minmet=1</tt>) method needs more, albeit less expensive, iterations. <span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><p class="line874">Note also that it is typically not critical to run to full convergence at the higher levels since these just serve as starting estimates for the lower levels. <span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span><p class="line867">
<h2 id="A--fwhm">--fwhm</h2>
<span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><p class="line862">Specifies the amount of smoothing that should be applied to the images in <tt class="backtick">--imain</tt>. It is typically a good idea to match this to the amount of sub-sampling you are using. An example would be the command <span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=my_b0_images&nbsp;--datain=my_acquisition_parameters&nbsp;--subsamp=4,2,1&nbsp;--fwhm=8,4,0</tt> <span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><p class="line862">which smoothes the <tt class="backtick">--imain</tt> images with an 8mm FWHM Gaussian filter prior to subsampling with a factor of 4 for the first level of sub-registration. For the second level it smoothes it by 4mm prior to subsampling by a factor of 2. For the final level it applies no smoothing at all. <span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><p class="line867">
<h2 id="A--lambda">--lambda</h2>
<span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><p class="line867">
<h2 id="A--estmov">--estmov</h2>
<span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span><p class="line862">Specifies wether or not to estimate the movement parameters (<tt class="backtick">--estmov=1</tt>) or keep them fixed (<tt class="backtick">--estmov=0</tt>) for that level. It is typically set to 1 for the early sub-sampling levels and changed to 0 for the later. The idea there is that already when we have estimated the warps at an intermediate resolution will we have estimated the movement parameters with sufficient precision to allow us to fix them for the reminder of the estimation. See the entry for <a href="./topup(2f)TopupUsersGuide.html#A--minmet">--minmet</a> below for an explanation of why that is beneficial. <span class="anchor" id="line-258"></span><span class="anchor" id="line-259"></span><p class="line867">
<h2 id="A--minmet">--minmet</h2>
<span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span><p class="line862">Specifies what minimisation method to use. The default (corresponding to <tt class="backtick">--minmet=0</tt>) is Gauss-Newton which uses explicit calculations of the gradient and Hessian to achieve convergence in a small number of iterations.<br>
 <span class="anchor" id="line-262"></span>A particular strength of Gauss-Newton is that it works well even when the values in the gradient have vastly different scales. Imagine for example changing the value of a spline coefficient by 1. That will change the warps in a very small part of the brain and might change the sum-of-squared differences by ~0.1%. Imagine now changing the value of the rotation parameter for rotation around the z-axis by 1 (<strong>N.B.</strong> 1 radian is ~57degrees). This will have a huge impact on the sum-of-squared differences and could easily change it by 1000%. So we have ~4 orders of magnitude in difference between these components of the gradient. This is a case that many (most) minimisation algorithms struggle very badly with, and in our experience it is really only Gauss-Newton (and derivates thereof) that is successful in these cases. Therefore we always recommend using Gauss-Newton (<tt class="backtick">--minmet=0</tt>) when estimating warps <em>and</em> movements.<br>
 <span class="anchor" id="line-263"></span>A problem with Gauss-Newton is that the calculation of the Hessian is time consuming and in particular the storage of it is very RAM demanding. When estimating the warps at full resolution the RAM requirement for the Hessian corresponds to ~700 image volumes. It can therefore be preferable to switch to the Scaled Conjugate Gradient method (<tt class="backtick">--minmet=1</tt>) when estimation the warps at the highest resolution. As explained above that can be a problem if one also tries to estimate the movement parameters. We therefore recommend keeping these constant (see <a href="./topup(2f)TopupUsersGuide.html#A--estmov">--estmov</a> above) when estimating the warps at the highest resolution levels. <span class="anchor" id="line-264"></span><span class="anchor" id="line-265"></span><p class="line867">
<h2 id="A--ssqlambda">--ssqlambda</h2>
<span class="anchor" id="line-266"></span><span class="anchor" id="line-267"></span><p class="line862">The use of several sub-sampling steps (with different values of <tt class="backtick">--lambda</tt>) helps prevent the registration from venturing into local minima. However, within a given sub-sampling step that regularisation is constant, and that could in turn cause the algorithm to take a &quot;poor&quot; initial step for that resolution level. By weighting <tt class="backtick">--lambda</tt> by the current value for the sum-of-squared differences the effective weight of the regularisation becomes higher for the initial iterations (when we are far from the solution and the sum-of-squares is large). That means that the initial step/steps are a little smoother than they would otherwise be, and hopefully that reduces the risk of finding a local minima. <span class="anchor" id="line-268"></span><span class="anchor" id="line-269"></span><p class="line867"><tt class="backtick">--ssqlambda</tt> is set to 1 as default, and it is typically a good idea to keep it like that. <strong>N.B.</strong> that the setting of <tt class="backtick">--ssqlambda</tt> influences the recommended value/values for <tt class="backtick">--lambda</tt>. The (average over all voxels) of the sum-of-squared differences is typically in the range 100-1000, and if <tt class="backtick">--ssqlambda</tt> is set to 0 the value/values for <tt class="backtick">--lambda</tt> should be adjusted up accordingly. <span class="anchor" id="line-270"></span><span class="anchor" id="line-271"></span><p class="line867">
<h2 id="A--regmod">--regmod</h2>
<span class="anchor" id="line-272"></span><span class="anchor" id="line-273"></span><p class="line862">The value of <tt class="backtick">--lambda</tt> determines the relative weight between the sum-of-squared differences and some function &amp;epsilon of the warps. However, it is not clear what the exact form of that function (&amp;epsilon(w)) should be. We clearly desire &quot;smoothness&quot; in the warps so that points that are close together in the original space ends up (reasonably) close together in the warped space, but there are many potential options for how a particular local warp should be penalised by &amp;epsilon(w). In topup we have implemented two different choices for &amp;epsilon(w): Membrane Energy (--regmod=membrane_energy) or Bending Energy (--regmod=bending_energy). Note that the two functions have vastly different scales. The membrane energy is based on the first derivatives and the bending energy on the second derivatives. The second derivatives will typically be much smaller than the first derivatives, and consequently &amp;lambda will have to be larger for bending energy to yield approximately the same level of regularisation. <span class="anchor" id="line-274"></span><span class="anchor" id="line-275"></span><p class="line867">
<h2 id="A--splineorder">--splineorder</h2>
<span class="anchor" id="line-276"></span><span class="anchor" id="line-277"></span><p class="line862">Specifies the order of the B-spline functions modelling the off-resonance field. A spline-function is a piecewise continuous polynomial-function and the order of the spline determines the order of the polynomial and the support of the spline. In topup one can use splines of order 2 (quadratic) or 3 (the &quot;well known&quot; cubic B-spline). A spline of lower order (2 in this case) has a smaller support, i.e. it &quot;covers&quot; fewer voxels, for a given knot-spacing/warp-resolution. This means that the calculation of the hessian matrix <strong>H</strong> in the minimisation will be faster, and also that <strong>H</strong> will be sparser and thus use require less memory. That means that going to <tt class="backtick">--splineorder=2</tt> (compared to the default 3) will allow you to push the resolution of the warps a little further and/or save execution time and memory. <span class="anchor" id="line-278"></span><span class="anchor" id="line-279"></span><p class="line862">The downside with a 2nd order spline is that the resulting field will not have continuous 2nd derivatives which creates some difficulties when using bending energy for regularisation. However, the approximations we are using seem to work so it is not obvious if there really is an issue. We are using <tt class="backtick">--splineorder=3</tt> as default in <tt class="backtick">topup</tt> because we have more experience with using that. It is not inconcievable that that will change as we gain more experience. <span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span><p class="line867">
<h2 id="A--numprec">--numprec</h2>
<span class="anchor" id="line-282"></span><span class="anchor" id="line-283"></span><p class="line862">Its value can be either float or double (default) and it specifies the precision that the hessian <strong>H</strong> is calculated and stored in. Changing this to float will decrease the amount of RAM needed to store <strong>H</strong> and will hence allow one to go to slightly higher warp-resolution before running into swapping problems. The default is double since that is what we have used for most of the testing and validation. <span class="anchor" id="line-284"></span><span class="anchor" id="line-285"></span><p class="line867">
<h2 id="A--interp">--interp</h2>
<span class="anchor" id="line-286"></span><span class="anchor" id="line-287"></span><p class="line862">When the transform x-&gt;x' maps to a point that is not on a voxel centre in the <tt class="backtick">--in</tt> volume, the pertinent intensity value will have to be deduced from the intensities at the surrounding voxel centres. This process is known as interpolation. In <tt class="backtick">topup</tt> there are two choices, tri-linear interpolation or cubic B-spline interpolation. In general, spline interpolation is more accurate at the cost of slightly longer execution time. Unlike the case for e.g. fnirt, spline interpolation seems to yield significantly better results than linear interpolation for <tt class="backtick">topup</tt>. We are still in the process of verifying this, but given how small the execution time penalty is there isn't much to loose in using it. Hence spline is the default. <span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span><p class="line867">
<h2 id="A--scale">--scale</h2>
<span class="anchor" id="line-290"></span><span class="anchor" id="line-291"></span><p class="line862">The registration is based on minimizing the sum-of-squared differences between the volumes in <tt class="backtick">--imain</tt>. Hence it is important that the intensities are comparable in the different acquisitions. If the same calibration scan was used for all acquisitions the intensities should be scaled identically and no re-scaling should be neccessary. If not it can be useful to re-scale the images to a common global mean by setting <tt class="backtick">--scale=1</tt>. Default is 0, i.e. no re-scaling of the images. <span class="anchor" id="line-292"></span><span class="anchor" id="line-293"></span><p class="line867">
<h2 id="A--regrid">--regrid</h2>
<span class="anchor" id="line-294"></span><span class="anchor" id="line-295"></span><p class="line862">When <tt class="backtick">--regrid=1</tt> (default) the registration will be performed to a target with a different grid-spacing than the input images. This is done to prevent <tt class="backtick">topup</tt> from &quot;finding&quot; small movements when the subject has remained completely motionless. The only reason to ever change this parameter is if you are a registration boffin and want to see what difference it makes.  <span class="anchor" id="line-296"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:30
</body>
</html>
