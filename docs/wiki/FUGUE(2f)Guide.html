<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FUGUE/Guide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FUGUE/Guide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./FUGUE.html">Introduction</a></li><li>Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#GUI_and_command_line_software">GUI and command line software</a></li><li>
<a href="#Making_Fieldmap_Images_for_FEAT">Making Fieldmap Images for FEAT</a><ol><li>
<a href="#SIEMENS_data">SIEMENS data</a></li><li>
<a href="#Non-SIEMENS_data">Non-SIEMENS data</a><ol><li>
<a href="#Processing_Steps">Processing Steps</a><ol><li>
<a href="#Step_1_-_Getting_the_magnitude_image">Step 1 - Getting the magnitude image</a></li><li>
<a href="#Step_2_-_Getting_.28wrapped.29_phase_in_radians">Step 2 - Getting (wrapped) phase in radians</a></li><li>
<a href="#Step_3_-_Unwrapping_the_phase_images">Step 3 - Unwrapping the phase images</a></li><li>
<a href="#Step_4_-_Getting_the_fieldmap_in_rad.2Fs">Step 4 - Getting the fieldmap in rad/s</a></li><li>
<a href="#Step_5_-_Regularising_the_fieldmap">Step 5 - Regularising the fieldmap</a></li></ol></li></ol></li></ol></li><li>
<a href="#Command-line_tools_.28advanced.29">Command-line tools (advanced)</a><ol><li>
<a href="#FUGUE">FUGUE</a></li><li>
<a href="#PRELUDE_.28phase_unwrapping.29">PRELUDE (phase unwrapping)</a></li></ol></li></ol></div></div></li><li><a href="./FUGUE(2f)FAQ.html">FAQ</a></li></ol></div> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line867">
<h1 id="GUI_and_command_line_software">GUI and command line software</h1>
<span class="anchor" id="line-4"></span><p class="line862">Two interfaces exist for applying FUGUE to unwarp images: (i) a GUI, that is part of the FEAT preprocessing options, and (ii) a command-line script, <tt class="backtick">epi_reg</tt>. We strongly recommend that new users make use of the pre-stats part of FEAT to do all such processing (note that it is not necessary to have fMRI data for this - even single volumes can be processed in FEAT by selecting pre-stats only). A GUI also exists for getting fieldmaps into the right form for FEAT. See the detailed documentation on FEAT and documentation below on using making fieldmaps for FEAT. <span class="anchor" id="line-5"></span><span class="anchor" id="line-6"></span><p class="line862">More experienced users, or those wanting to use fieldmap-based distortion-correction in other situations, can use the <tt class="backtick">epi_reg</tt> command.  The documentation for this command can be found as part of <a href="./FLIRT.html">FLIRT</a>. <span class="anchor" id="line-7"></span><span class="anchor" id="line-8"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-9"></span><br>
 <span class="anchor" id="line-10"></span><span class="anchor" id="line-11"></span><p class="line867">
<h1 id="Making_Fieldmap_Images_for_FEAT">Making Fieldmap Images for FEAT</h1>
<span class="anchor" id="line-12"></span><p class="line862">This section outlines some of the most common ways to construct the required fieldmap images for B0 unwarping in FEAT. Also see the documentation on <a href="./FEAT.html">FEAT</a> for more information on fieldmapping and its use in FEAT pre-stats processing. <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span><p class="line874">Each scanner/site/sequence can give you different data. As the phase is of great importance in fieldmapping, but is normally not saved in other sequences, these images are often quite different from the standard images. <span class="anchor" id="line-15"></span><span class="anchor" id="line-16"></span><p class="line867">
<h2 id="SIEMENS_data">SIEMENS data</h2>
<span class="anchor" id="line-17"></span><p class="line862">If you have data from a SIEMENS scanner then we strongly recommend that the tool <tt class="backtick">fsl_prepare_fieldmap</tt> is used to generate the required input data for FEAT or <tt class="backtick">fugue</tt>.  Fieldmap data from a SIEMENS scanner takes the form of one phase difference image and two magnitude images (one for each echo time).  In the following, where a magnitude image is required, pick the &quot;best looking&quot; one.  This image is used for registration and masking but the process is not particularly sensitive to the quality and typically either image will work fine. <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line862">There are both GUI and command-line versions of the <tt class="backtick">fsl_prepare_fieldmap</tt> tool.  It is recommended that new users use the GUI. <span class="anchor" id="line-20"></span><span class="anchor" id="line-21"></span><p class="line862">The <tt class="backtick">Fsl_prepare_fieldmap</tt> GUI requires the following input: <span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><ul><li>Phase image <span class="anchor" id="line-24"></span></li><li>Magnitude image (brain extracted - see note below) <span class="anchor" id="line-25"></span></li><li>Difference of Echo Times - this is a sequence parameter that your scanner operator/radiographer/technician should know, but make sure you record the value <span class="anchor" id="line-26"></span><span class="anchor" id="line-27"></span></li></ul><p class="line862">Brain extraction of the magnitude image is very important and must be <em>tight</em> - that is, it must exclude all non-brain voxels and any voxels with only a small partial volume contribution.  The reason for this is that these areas are normally very noisy in the phase image (look at them in FSLView - if they are not noisy then this is not so important).  It is crucial that the mask (derived from this brain extracted image) contains few of these noisy voxels.  This is most easily done by making the brain extraction very tight, erring on excluding brain voxels.  The exclusion of brain voxels in this instance is actually fine and will have no repercussions, since the fieldmap is extrapolated beyond this mask, and that is the only purpose that the mask plays.  Therefore make sure your mask is (if it can't be perfect) too small.  As noted above, either magnitude image (from the different echos) can normally be used here - it is not that important. <span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line862">The output of the <tt class="backtick">Fsl_prepare_fieldmap</tt> GUI is a correctly calibrated fieldmap in units of rad/s (as the B0 field can be measured in Tesla, Hz or rad/s in MRI as they are all proportional). <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line862">The usage of the <tt class="backtick">fsl_prepare_fieldmap</tt> command-line tool is very similar to the GUI (and all the above considerations apply): <span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line867"><span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><pre><span class="anchor" id="line-1"></span>Usage: fsl_prepare_fieldmap &lt;scanner&gt; &lt;phase_image&gt; &lt;magnitude_image&gt; &lt;out_image&gt; &lt;deltaTE (in ms)&gt; [--nocheck]
<span class="anchor" id="line-2"></span>
<span class="anchor" id="line-3"></span>  Prepares a fieldmap suitable for FEAT from SIEMENS data - saves output in rad/s format
<span class="anchor" id="line-4"></span>  &lt;scanner&gt; must be SIEMENS
<span class="anchor" id="line-5"></span>  &lt;magnitude image&gt; should be Brain Extracted (with BET or otherwise)
<span class="anchor" id="line-6"></span>  &lt;deltaTE&gt; is the echo time difference of the fieldmap sequence - find this out form the operator (defaults are *usually* 2.46ms on SIEMENS )
<span class="anchor" id="line-7"></span>  --nocheck supresses automatic sanity checking of image size/range/dimensions
<span class="anchor" id="line-8"></span>
<span class="anchor" id="line-9"></span>   e.g. fsl_prepare_fieldmap SIEMENS images_3_gre_field_mapping images_4_gre_field_mapping fmap_rads 2.65</pre><span class="anchor" id="line-44"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-45"></span><hr /><p class="line874"> <span class="anchor" id="line-46"></span>
<h2 id="Non-SIEMENS_data">Non-SIEMENS data</h2>
<span class="anchor" id="line-47"></span><p class="line862">Currently <tt class="backtick">fsl_prepare_fieldmap</tt> does not work with non-SIEMENS data.  We welcome collaboration from people using such scanners in order to enhance this tool. In the meantime, when dealing with data from another scanner manufacturer, the first step in practice is to find out what kind of fieldmap acquisition data you can get from the scanner, operator or reconstruction software. There are three main types: <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><ol type="1"><li>Complex data containing images at two different echo times <span class="anchor" id="line-50"></span></li><li>Separate phase images for the two different echo times <span class="anchor" id="line-51"></span></li><li>A single, real fieldmap image (showing the field inhomogeneity in each voxel) <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span></li></ol><p class="line862">If the images from the scanner are in ANALYZE or NIFTI form then you can determine their type, use <tt class="backtick">fslinfo</tt>. If not, you must convert to either ANALYZE or NIFTI format before progressing. See the FSL FAQ for information about conversion. <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><p class="line862">When <tt class="backtick">fslinfo</tt> is run it will display a datatype string or number (the value 32 represents a complex image). You can convert a complex image into its phase and magnitude components by using <tt class="backtick">fslcomplex</tt> or, alternatively, leave it in this format. The number of images contained in each file is shown as the <tt class="backtick">dim4</tt> value. <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><p class="line862">To further check what sort of images you have, use <tt class="backtick">slices</tt> to display the image and then see which of the following images it most closely resembles. Note that for complex images, slices will display two separate images - one phase and one magnitude. If you only have a single image (dim4=1) then it is possible that it has already been reconstructed fully into a fieldmap. <span class="anchor" id="line-58"></span><span class="anchor" id="line-59"></span><p class="line874">Typical complex images <span class="anchor" id="line-60"></span><div><table><tbody><tr>  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="complex_phase.png" class="attachment" src="attachments/FUGUE(2f)Guide/complex_phase.png" title="complex_phase.png" /> </td>
  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="complex_abs.png" class="attachment" src="attachments/FUGUE(2f)Guide/complex_abs.png" title="complex_abs.png" /> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><p class="line874">A phase image (wrapped) <span class="anchor" id="line-66"></span><div><table><tbody><tr>  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="complex_phase.png" class="attachment" src="attachments/FUGUE(2f)Guide/complex_phase.png" title="complex_phase.png" /> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><span class="anchor" id="line-71"></span><p class="line874">A phase image (unwrapped and masked) <span class="anchor" id="line-72"></span><div><table><tbody><tr>  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="unwrapped_phase.png" class="attachment" src="attachments/FUGUE(2f)Guide/unwrapped_phase.png" title="unwrapped_phase.png" /> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><p class="line874">A magnitude image <span class="anchor" id="line-78"></span><div><table><tbody><tr>  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="complex_abs.png" class="attachment" src="attachments/FUGUE(2f)Guide/complex_abs.png" title="complex_abs.png" /> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><p class="line874">A real fieldmap image (masked) <span class="anchor" id="line-84"></span><div><table><tbody><tr>  <td style="&amp;quot; &amp;amp; quot; border:none;  &amp;amp; quot; &amp;quot;"><p class="line862"> <img alt="fmap.png" class="attachment" src="attachments/FUGUE(2f)Guide/fmap.png" title="fmap.png" /> </td>
</tr>
</tbody></table></div><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><span class="anchor" id="line-89"></span><p class="line874">Note that the fieldmap image contains structure and shows substantial inhomogeneities mainly in the inferior regions of the brain. <span class="anchor" id="line-90"></span><span class="anchor" id="line-91"></span><p class="line874">It is most common to have wrapped phase and magnitude images (case 2 below). If the images appear to have unwrapped phase then the the PRELUDE stage (step 3) should be skipped. However, if the range of values within the image is within 2 pi radians (6.28) then it is likely that there are wraps present (even if they are hard to find by eye) and so, in this case, PRELUDE should still be run. <span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><p class="line874">Once you have determined the type, you need to do some or all of the following steps. As a guide (and this may vary in some cases) the steps that are required are: <span class="anchor" id="line-94"></span><span class="anchor" id="line-95"></span><p class="line874">For complex data you need to do steps 1a, 2a, 3, 4a and 5 For a pair of phase images you need to do steps 1b, 1c, 2b, 3, 4a and 5 For a single, real fieldmap you need to do steps 1b, 1c, 4b and 5 <span class="anchor" id="line-96"></span><span class="anchor" id="line-97"></span><p class="line867">
<h3 id="Processing_Steps">Processing Steps</h3>
<span class="anchor" id="line-98"></span><p class="line867">
<h4 id="Step_1_-_Getting_the_magnitude_image">Step 1 - Getting the magnitude image</h4>
<span class="anchor" id="line-99"></span><p class="line867"><strong>(a)</strong> If you start with a complex Analyze or Nifti volume that contains the scans at two echo times then you need to do: <span class="anchor" id="line-100"></span><span class="anchor" id="line-101"></span><p class="line867"><tt class="backtick">fslcomplex&nbsp;-realabs&nbsp;complex_acq&nbsp;fieldmap_mag</tt> <span class="anchor" id="line-102"></span><span class="anchor" id="line-103"></span><p class="line867"><strong>(b)</strong> If you have separate phase images or a single, fieldmap image, then you need to also get a magnitude image that is (i) undistorted and (ii) registered with this phase/fieldmap image. Usually the sequence used to acquire the phase or fieldmap image also contains data that can give you this magnitude image. Check with your scanner operator, physicists and/or analysis people as to how to reconstruct this image - often it just requires extraction from the original DICOM or vendor-specific format. <span class="anchor" id="line-104"></span><span class="anchor" id="line-105"></span><p class="line867"><strong>(c)</strong> Check that the magnitude image and the phase/fieldmap images have the same resolution. You can do this by looking at the dim and pixdim entries (only the first three of each) as reported by <tt class="backtick">fslinfo</tt>. <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><p class="line862">If they are not the same then they must be resampled to be equal. In this case choose the one with the best resolution and use this as a reference image in <tt class="backtick">flirt</tt> with the <tt class="backtick">-applyxfm</tt> option to resample the other images.  For example, if the magnitude image has a better resolution (smaller pixdims) then do the following: <span class="anchor" id="line-108"></span><span class="anchor" id="line-109"></span><p class="line867"><tt class="backtick">flirt&nbsp;-in&nbsp;original_phase0&nbsp;-ref&nbsp;fieldmap_mag&nbsp;-applyxfm&nbsp;-out&nbsp;orig_phase0</tt><br>
 <tt class="backtick">flirt&nbsp;-in&nbsp;original_phase1&nbsp;-ref&nbsp;fieldmap_mag&nbsp;-applyxfm&nbsp;-out&nbsp;orig_phase1</tt> <span class="anchor" id="line-110"></span><span class="anchor" id="line-111"></span><p class="line862">Once this is done, check that the output images (e.g. orig_phase0) have the same dimensions and resolution as the reference (using <tt class="backtick">fslinfo</tt>) and <strong>also</strong> check that they are aligned correctly by loading both the output and reference images into <tt class="backtick">fslview</tt> and visually inspecting them. <span class="anchor" id="line-112"></span><span class="anchor" id="line-113"></span><p class="line867">
<h4 id="Step_2_-_Getting_.28wrapped.29_phase_in_radians">Step 2 - Getting (wrapped) phase in radians</h4>
<span class="anchor" id="line-114"></span><p class="line867"><strong>(a)</strong> If you have complex volumes then do: <span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span><p class="line867"><tt class="backtick">fslcomplex&nbsp;-realphase&nbsp;complex_acq&nbsp;phase0_rad&nbsp;0&nbsp;1</tt><br>
 <tt class="backtick">fslcomplex&nbsp;-realphase&nbsp;complex_acq&nbsp;phase1_rad&nbsp;1&nbsp;1</tt> <span class="anchor" id="line-117"></span><span class="anchor" id="line-118"></span><p class="line862">These phase volumes will now be in radians. <strong>(b)</strong> If you have seperate phase volumes that are in integer format then do: <span class="anchor" id="line-119"></span><span class="anchor" id="line-120"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;orig_phase0&nbsp;-mul&nbsp;3.14159&nbsp;-div&nbsp;2048&nbsp;phase0_rad&nbsp;-odt&nbsp;float</tt><br>
 <tt class="backtick">fslmaths&nbsp;orig_phase1&nbsp;-mul&nbsp;3.14159&nbsp;-div&nbsp;2048&nbsp;phase1_rad&nbsp;-odt&nbsp;float</tt> <span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><p class="line874">Note that the value of 2048 needs to be adjusted for each different site/scanner/sequence in order to be correct. The final range of the phase0_rad image should be approximately 0 to 6.28. If this is not the case then this scaling is wrong. If you have separate phase volumes are not in integer format, you must still check that the units are in radians, and if not scale them appropriately using fslmaths. <span class="anchor" id="line-123"></span><span class="anchor" id="line-124"></span><p class="line867">
<h4 id="Step_3_-_Unwrapping_the_phase_images">Step 3 - Unwrapping the phase images</h4>
<span class="anchor" id="line-125"></span><p class="line874">Use PRELUDE to do the required phase unwrapping <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><p class="line867"><tt class="backtick">prelude&nbsp;-a&nbsp;fieldmap_mag&nbsp;-p&nbsp;phase0_rad&nbsp;-o&nbsp;phase0_unwrapped_rad</tt><br>
 <tt class="backtick">prelude&nbsp;-a&nbsp;fieldmap_mag&nbsp;-p&nbsp;phase1_rad&nbsp;-o&nbsp;phase1_unwrapped_rad</tt> <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><p class="line867">
<h4 id="Step_4_-_Getting_the_fieldmap_in_rad.2Fs">Step 4 - Getting the fieldmap in rad/s</h4>
<span class="anchor" id="line-130"></span><p class="line867"><strong>(a)</strong> For separate phase images do: <span class="anchor" id="line-131"></span><span class="anchor" id="line-132"></span><p class="line867"><tt class="backtick">fslmaths&nbsp;phase1_unwrapped_rad&nbsp;-sub&nbsp;phase0_unwrapped_rad&nbsp;-mul&nbsp;1000&nbsp;-div&nbsp;TE&nbsp;fieldmap_rads&nbsp;-odt&nbsp;float</tt> where <strong>TE</strong> must be replaced with the appropriate difference in echo times (in units of milliseconds). <span class="anchor" id="line-133"></span><span class="anchor" id="line-134"></span><p class="line867"><strong>(b)</strong> If you have a single, real fieldmap then you must determine the units of this fieldmap (ask an operator/physicist) and rescale to radians per second if it is not already in these units. Common other units are (i) Hz (scale these by 6.28 to get rad/s) and (ii) Telsa (scale these by 2.68e8 to get rad/s). <span class="anchor" id="line-135"></span><span class="anchor" id="line-136"></span><p class="line867">
<h4 id="Step_5_-_Regularising_the_fieldmap">Step 5 - Regularising the fieldmap</h4>
<span class="anchor" id="line-137"></span><p class="line862">Fieldmaps can often be noisy or be contaminated around the edges of the brain. To correct for this you can regularise the fieldmap using <tt class="backtick">fugue</tt>. Note that the &quot;best&quot; regularisation will depend on many factors in the acquisition and must be determined separately for each site/scanner/sequence. Look at the fieldmap (e.g. using <tt class="backtick">fslview</tt>) to decide what is the best regularisation to use - which could also be to do no regularisation. <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span><p class="line874">Some regularisation options are - Gaussian smoothing, despiking and median filtering. Examples of these (in order) are: <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span><p class="line867"><tt class="backtick">fugue&nbsp;--loadfmap=fieldmap_rads&nbsp;-s&nbsp;1&nbsp;--savefmap=fieldmap_rads</tt><br>
 <tt class="backtick">fugue&nbsp;--loadfmap=fieldmap_rads&nbsp;--despike&nbsp;--savefmap=fieldmap_rads</tt><br>
 <tt class="backtick">fugue&nbsp;--loadfmap=fieldmap_rads&nbsp;-m&nbsp;--savefmap=fieldmap_rads</tt> <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span><p class="line862">Any combination of these regularisations can be performed. See the command-line documentation on <tt class="backtick">fugue</tt> below for more information aspects of regularisation. <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-146"></span><hr /><p class="line874"> <span class="anchor" id="line-147"></span><br>
 <span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><p class="line867">
<h1 id="Command-line_tools_.28advanced.29">Command-line tools (advanced)</h1>
<span class="anchor" id="line-150"></span><p class="line874">For all programs the options follow the normal convention that &quot;single minus&quot; options are separated by a space from their arguments (if any) whilst &quot;double minus&quot; options are separated by an equals sign and no space. For example, <span class="anchor" id="line-151"></span><span class="anchor" id="line-152"></span><p class="line867"><tt class="backtick">prelude&nbsp;-c&nbsp;data&nbsp;--unwrap=result</tt> <span class="anchor" id="line-153"></span><span class="anchor" id="line-154"></span><p class="line874">or <span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span><p class="line867"><tt class="backtick">prelude&nbsp;--complex=data&nbsp;-u&nbsp;result</tt> <span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span><p class="line867">
<h2 id="FUGUE">FUGUE</h2>
<span class="anchor" id="line-159"></span><p class="line874">fugue (FMRIB's Utility for Geometrically Unwarping EPIs) performs unwarping of an EPI image based on fieldmap data. The input required consists of the EPI image, the fieldmap (as an unwrapped phase map or a scaled fieldmap in rad/s) and appropriate image sequence parameters for the EPI and fieldmap acquisitions: the dwell time for EPI (also known as the echo spacing); and the echo time difference (called asym time herein). The main forms of usage are: <span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span><p class="line867"><tt class="backtick">fugue&nbsp;-i&nbsp;epi&nbsp;-p&nbsp;unwrappedphase&nbsp;--dwell=dwelltime&nbsp;--asym=asymtime&nbsp;-s&nbsp;0.5&nbsp;-u&nbsp;result</tt> <span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span><ul><li style="list-style-type:none">fieldmap specified by a 4D file unwrappedphase containing two unwrapped phase images - from different echo times - plus the dwell time and echo time difference (asym time) <span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span></li></ul><p class="line867"><tt class="backtick">fugue&nbsp;-i&nbsp;epi&nbsp;--dwell=dwelltime&nbsp;--loadfmap=fieldmap&nbsp;-u&nbsp;result</tt> <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><ul><li style="list-style-type:none">uses a previously calculated fieldmap <span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span></li></ul><p class="line862">Note the option <tt class="backtick">-s&nbsp;0.5</tt> is an example of how to specify the regularisation to apply to the fieldmap (2D Gaussian smoothing of sigma=0.5 in this case which is a reasonable default). There are many different forms of regularisation available which can be applied separately or together. These are: <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span><p class="line867"><tt class="backtick">-s&nbsp;sigma</tt> <span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span><ul><li style="list-style-type:none">2D Gaussian smoothing <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span></li></ul><p class="line867"><tt class="backtick">--smooth3=sigma</tt> <span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><ul><li style="list-style-type:none">3D Gaussian smoothing <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span></li></ul><p class="line867"><tt class="backtick">-m</tt> <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span><ul><li style="list-style-type:none">2D median filtering <span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span></li></ul><p class="line867"><tt class="backtick">--poly=n</tt> <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span><ul><li style="list-style-type:none">3D Polynomial fitting of degree n <span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span></li></ul><p class="line867"><tt class="backtick">--fourier=n</tt> <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span><ul><li style="list-style-type:none">3D Sinusoidal fitting of degree n <span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span></li></ul><p class="line874">Some other uses are: <span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span><p class="line867"><tt class="backtick">fugue&nbsp;-i&nbsp;undistortedimage&nbsp;-p&nbsp;unwrappedphase&nbsp;--dwell=dwelltime&nbsp;--asym=asymtime&nbsp;--nokspace&nbsp;-s&nbsp;0.5&nbsp;-w&nbsp;warpedimage</tt> <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><p class="line874">applies the fieldmap as a forward warp, turning an undistorted image into a distorted one - useful for creating a registration target for the EPI from the undistorted absolute fieldmap image Additional options that are useful are: <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span><p class="line867"><tt class="backtick">--mask=maskname</tt> <span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span><ul><li style="list-style-type:none">uses a user-defined mask (called maskname) instead of deriving it from the phasemaps or fieldmaps <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span></li></ul><p class="line867"><tt class="backtick">--unwarpdir=dir</tt> <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><ul><li style="list-style-type:none"><p class="line862">specifies the direction of the unwarping/warping - i.e. phase-encode direction - with <tt class="backtick">dir</tt> being one of <tt class="backtick">x,y,z,x-,y-,z-</tt> (default is y). <span class="anchor" id="line-204"></span></li><li style="list-style-type:none"><span class="anchor" id="line-205"></span></li><li style="list-style-type:none">Note: the conventions for x, y and z are voxel axes (in the input image), but with the x-axis being swapped if the qform or sform determinant is positive (to match the internal FSL voxel coordinate axes), though due to other possible changes in the pipeline for reconstructing/analysing both the EPI and fieldmap images, it is usually necessary to determine the sign of the direction by trial-and-error once for each scanning/reconstruction/analysis protocol (each dataset using the same protocol will need the same unwarpdir). <span class="anchor" id="line-206"></span><span class="anchor" id="line-207"></span></li></ul><p class="line867"><tt class="backtick">--phaseconj</tt> <span class="anchor" id="line-208"></span><span class="anchor" id="line-209"></span><ul><li style="list-style-type:none">uses the phase conjugate correction method, rather than pixel shifts <span class="anchor" id="line-210"></span><span class="anchor" id="line-211"></span></li></ul><p class="line867"><tt class="backtick">--nokspace</tt> <span class="anchor" id="line-212"></span><span class="anchor" id="line-213"></span><ul><li style="list-style-type:none">for forward warping (only) - uses an image-space method for forward warping <span class="anchor" id="line-214"></span><span class="anchor" id="line-215"></span></li></ul><p class="line867"><tt class="backtick">--icorr</tt> <span class="anchor" id="line-216"></span><span class="anchor" id="line-217"></span><ul><li style="list-style-type:none">applies an intensity correction term when using the pixel shift method - often poorly conditioned for standard fieldmap acquisitions <span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-220"></span>
<h2 id="PRELUDE_.28phase_unwrapping.29">PRELUDE (phase unwrapping)</h2>
<span class="anchor" id="line-221"></span><p class="line867"><tt class="backtick">prelude</tt> ( Phase Region Expanding Labeller for Unwrapping Discrete Estimates ) performs 3D phase unwrapping of images. As the name implies, it should be run before <tt class="backtick">fugue</tt> in order to get a correct fieldmap.  This is useful for fieldmap acquisitions, susceptibility weighted imaging (SWI), or other applications involving phase in MR (or non-MR) images. The input can either be a single complex image (NIfTI or Analyze), or a pair of real images giving the phase and absolute values separately. Also see <a href="./Fslutils.html">Fslutils</a> for more ways to manipulate complex image formats. If the images are 4D images, then each 3D volume is unwrapped separately, and the result saved as a 4D image of unwrapped phase images. The output in either case is a real, unwrapped phase image (in radians). <span class="anchor" id="line-222"></span><span class="anchor" id="line-223"></span><p class="line874">For higher resolution images (e.g. for Susceptibility Weighted Imaging) a mask should be used in order to reduce run-times since any areas that include noisy voxels will significantly increase the required run-time. The best way to generate a mask for a whole brain image is to run BET to perform brain extraction on the absolute image. <span class="anchor" id="line-224"></span><span class="anchor" id="line-225"></span><p class="line874">The three main forms of usage are: <span class="anchor" id="line-226"></span><span class="anchor" id="line-227"></span><p class="line867"><tt class="backtick">prelude&nbsp;-c&nbsp;data&nbsp;-u&nbsp;result</tt> <span class="anchor" id="line-228"></span><span class="anchor" id="line-229"></span><ul><li style="list-style-type:none">uses a single complex input file <span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span></li></ul><p class="line867"><tt class="backtick">prelude&nbsp;-a&nbsp;data_abs&nbsp;-p&nbsp;data_phase&nbsp;-u&nbsp;result</tt> <span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><ul><li style="list-style-type:none">uses separate phase and absolute input files <span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span></li></ul><p class="line867"><tt class="backtick">prelude&nbsp;-a&nbsp;data_abs&nbsp;-p&nbsp;data_phase&nbsp;-u&nbsp;result&nbsp;-m&nbsp;mask</tt> <span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><ul><li style="list-style-type:none">uses separate phase and absolute input files with a mask <span class="anchor" id="line-238"></span><span class="anchor" id="line-239"></span></li></ul><p class="line874">Additional options that are useful are: <span class="anchor" id="line-240"></span><span class="anchor" id="line-241"></span><p class="line867"><tt class="backtick">-m&nbsp;mask</tt> <span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span><ul><li style="list-style-type:none">uses the user-defined mask (e.g. a BET mask - especially for high resolution images) <span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span></li></ul><p class="line867"><tt class="backtick">-n&nbsp;num</tt> <span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span><ul><li style="list-style-type:none">specifies the number of phase partitions the algorithm uses for initial labelling - a larger value is likely to be more robust but slower <span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span></li></ul><p class="line867"><tt class="backtick">-s</tt> <span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span><ul><li style="list-style-type:none">unwrap in 2D, then stick slices together with appropriate offsets - this is less robust but fast - mainly used for very high-resolution images where optimising speed is an issue <span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span></li></ul><p class="line867"><tt class="backtick">--labelslices</tt> <span class="anchor" id="line-254"></span><span class="anchor" id="line-255"></span><ul><li style="list-style-type:none">does labelling in 2D, but unwrapping in 3D - the default for high-res images <span class="anchor" id="line-256"></span><span class="anchor" id="line-257"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-258"></span><a href="./CategoryFUGUE.html">CategoryFUGUE</a> <span class="anchor" id="line-259"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:28
</body>
</html>
