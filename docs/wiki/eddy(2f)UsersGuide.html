<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>eddy/UsersGuide</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">eddy/UsersGuide</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><span class="anchor" id="line-4"></span><p class="line867"><div class="FslToolContents">
<h1>Contents</h1>
<ol><li><a href="./eddy.html">Introduction</a></li><li>Users Guide<div class="contentslist"><div class="table-of-contents"><p class="table-of-contents-heading">Contents<ol><li>
<a href="#Running_eddy">Running eddy</a><ol><li>
<a href="#The_data">The data</a></li><li>
<a href="#Running_topup_on_the_b.3D0_volumes">Running topup on the b=0 volumes</a></li><li>
<a href="#Running_eddy-1">Running eddy</a></li><li>
<a href="#eddy_with_outlier_replacement">eddy with outlier replacement</a></li><li>
<a href="#Understanding_eddy_output">Understanding eddy output</a></li></ol></li><li>
<a href="#List_of_parameters">List of parameters</a></li><li>
<a href="#Parameters_explained">Parameters explained</a><ol><li>
<a href="#A--imain">--imain</a></li><li>
<a href="#A--mask">--mask</a></li><li>
<a href="#A--acqp">--acqp</a></li><li>
<a href="#A--index">--index</a></li><li>
<a href="#A--bvecs">--bvecs</a></li><li>
<a href="#A--bvals">--bvals</a></li><li>
<a href="#A--topup">--topup</a></li><li>
<a href="#A--field">--field</a></li><li>
<a href="#A--field_mat">--field_mat</a></li><li>
<a href="#A--out">--out</a></li><li>
<a href="#A--flm">--flm</a></li><li>
<a href="#A--slm">--slm</a></li><li>
<a href="#A--fwhm">--fwhm</a></li><li>
<a href="#A--niter">--niter</a></li><li>
<a href="#A--fep">--fep</a></li><li>
<a href="#A--interp">--interp</a></li><li>
<a href="#A--resamp">--resamp</a></li><li>
<a href="#A--nvoxhp">--nvoxhp</a></li><li>
<a href="#A--ff">--ff</a></li><li>
<a href="#A--dont_sep_offs_move">--dont_sep_offs_move</a></li><li>
<a href="#A--dont_peas">--dont_peas</a></li><li>
<a href="#A--repol">--repol</a></li><li>
<a href="#A--ol_nstd">--ol_nstd</a></li><li>
<a href="#A--ol_nvox">--ol_nvox</a></li><li>
<a href="#A--ol_type">--ol_type</a></li><li>
<a href="#A--ol_pos">--ol_pos</a></li><li>
<a href="#A--ol_sqr">--ol_sqr</a></li><li>
<a href="#A--mb">--mb</a></li><li>
<a href="#A--mb_offs">--mb_offs</a></li><li>
<a href="#A--data_is_shelled">--data_is_shelled</a></li><li>
<a href="#A--verbose">--verbose</a></li><li>
<a href="#A--help">--help</a></li></ol></li></ol></div></div></li><li><a href="./eddy(2f)Faq.html">FAQ</a></li></ol></div> <span class="anchor" id="line-5"></span>
<h1 id="Running_eddy">Running eddy</h1>
<span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><p class="line862">Running <tt class="backtick">eddy</tt> is a little bit more complicated than running for example its predecessor <tt class="backtick">eddy_correct</tt>. The reasons for this are <span class="anchor" id="line-8"></span><span class="anchor" id="line-9"></span><ul><li><p class="line891"><tt class="backtick">eddy</tt> attempts to combine the correction for susceptibility and eddy currents/movements so that there is only one single resampling. This means we need to &quot;inform&quot; <tt class="backtick">eddy</tt> of the results from <a href="./topup.html">topup</a> (which is used to calculate the susceptibility distortions). <span class="anchor" id="line-10"></span></li><li><p class="line862">Unlike <tt class="backtick">eddy_correct</tt>, <tt class="backtick">eddy</tt> attempts to model the diffusion signal. This means that <tt class="backtick">eddy</tt> needs to be informed of the diffusion direction/weighting that was used for each volume. <span class="anchor" id="line-11"></span></li><li><p class="line891"><tt class="backtick">eddy</tt> can utilise the information from different acquisitions that modulate how off-resonance translates into distortions. An example of this would be acquisitions with different polarity of the phase-encoding. Hence we need to inform <tt class="backtick">eddy</tt> about how each volume was acquired. <span class="anchor" id="line-12"></span><span class="anchor" id="line-13"></span></li></ul><p class="line862">The need to pass more information to <tt class="backtick">eddy</tt> results in a more complicated command line. Here I will outline a typical use of <a href="./topup.html">topup</a> and <tt class="backtick">eddy</tt> (they are really intended to be used together) on a &quot;typical&quot; data set suited for use with <tt class="backtick">eddy</tt>. <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span><p class="line867">
<h2 id="The_data">The data</h2>
<span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line862">The data for this example consists of one set of volumes acquired with phase-encoding A&gt;&gt;P consisting of 5 b=0 volumes and 59 diffusion weighted volumes  <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><div><table><tbody><tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><p class="line891"><tt class="backtick">data.nii.gz</tt></td>
</tr>
<tr>  <td><span class="anchor" id="line-20"></span><p class="line891"><img align="top" alt="A2P_five_volumes.jpeg" class="attachment" src="attachments/eddy(2f)UsersGuide/A2P_five_volumes.jpeg" title="A2P_five_volumes.jpeg" width="800" /></td>
</tr>
<tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><span class="anchor" id="line-21"></span><p class="line862">First b=0 volume and the first four dwis of the A&gt;&gt;P data</td>
</tr>
</tbody></table></div><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><p class="line862">and one single b=0 volume with phase-encoding P&gt;&gt;A. <span class="anchor" id="line-24"></span><span class="anchor" id="line-25"></span><div><table><tbody><tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><p class="line891"><tt class="backtick">P2A_b0.nii.gz</tt></td>
</tr>
<tr>  <td><span class="anchor" id="line-26"></span><p class="line891"><img align="top" alt="P2A_b0.jpeg" class="attachment" src="attachments/eddy(2f)UsersGuide/P2A_b0.jpeg" title="P2A_b0.jpeg" width="160" /></td>
</tr>
<tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><span class="anchor" id="line-27"></span><p class="line862">The P&gt;&gt;A data</td>
</tr>
</tbody></table></div><span class="anchor" id="line-28"></span><span class="anchor" id="line-29"></span><p class="line862">Note how the shape of the b=0 scan is different for the two different acquisitions. This is what <a href="./topup.html">topup</a> will use in order to calculate the susceptibility induced off-resonance field. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span><p class="line867">
<h2 id="Running_topup_on_the_b.3D0_volumes">Running topup on the b=0 volumes</h2>
<span class="anchor" id="line-32"></span><span class="anchor" id="line-33"></span><p class="line862">The first thing we do is to run <a href="./topup.html">topup</a> to estimate the susceptibility induced off-resonance field. In order to prepare the data for <a href="./topup.html">topup</a> we issue the following commands <span class="anchor" id="line-34"></span><span class="anchor" id="line-35"></span><p class="line867"><span class="anchor" id="line-36"></span><span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span><span class="anchor" id="line-39"></span><pre><span class="anchor" id="line-1"></span>fslroi data A2P_b0 0 1
<span class="anchor" id="line-2"></span>fslmerge -t A2P_P2A_b0 A2P_b0 P2A_b0
<span class="anchor" id="line-3"></span>printf &quot;0 -1 0 0.0646\n0 1 0 0.0646&quot; &gt; acqparams.txt </pre><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><p class="line862">The first two commands will produce a file called <tt class="backtick">A2P_P2A_b0.nii.gz</tt> containing the two b=0 volume, and the third command will create a file (named <tt class="backtick">acqparams.txt</tt>) that informs <a href="./topup.html">topup</a>/<tt class="backtick">eddy</tt> of how the data was collected. This file is described <a class="nonexistent" href="./topup(2f)TopupUsersGuide(2f).html#A--datain">here</a>, <a href="./eddy(2f)UsersGuide.html#A--acqp">here</a> and in more detail <a href="./eddy(2f)Faq.html#How_do_I_know_what_to_put_into_my_--acqp_file">here</a>. <span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><p class="line862">Now it is time to run <a href="./topup.html">topup</a> which we do with the command <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><p class="line867"><tt class="backtick">topup&nbsp;--imain=A2P_P2A_b0&nbsp;--datain=acqparams.txt&nbsp;--config=b02b0.cnf&nbsp;--out=my_topup_results&nbsp;--iout=my_hifi_b0</tt> <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line862">which will give us as our main result a file named <tt class="backtick">my_topup_results_fieldcoef.nii.gz</tt> which contains an estimate of the susceptibility induced off-resonance field. <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span><p class="line867">
<h2 id="Running_eddy-1">Running eddy</h2>
<span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><p class="line862">Before we can run <tt class="backtick">eddy</tt> we need to do a couple of more preparations. First of all we need a mask that separate brain from non-brain. This is no different from for example the mask that <a href="./FDT(2f)UserGuide.html#DTIFIT">`dtifit`</a> needs. Since <tt class="backtick">eddy</tt> will work in a non-distorted space we will base the mask on <tt class="backtick">my_hifi_b0.nii.gz</tt> (the secondary output from our <a href="./topup.html">topup</a> command above). We generate this mask with the commands <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span><p class="line867"><span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><pre><span class="anchor" id="line-1-1"></span>fslmaths my_hifi_b0 -Tmean my_hifi_b0
<span class="anchor" id="line-2-1"></span>bet my_hifi_b0 my_hifi_b0_brain -m</pre><span class="anchor" id="line-57"></span><span class="anchor" id="line-58"></span><p class="line862">which results in the file <tt class="backtick">my_hifi_b0_brain_mask.nii.gz</tt>. It may be a good idea to check this stage to ensure <tt class="backtick">bet</tt> has done a good job of extracting the brain.  <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><p class="line862">The final thing we need to do is to create an index file that tells <tt class="backtick">eddy</tt> which line/of the lines in the <tt class="backtick">acqparams.txt</tt> file that are relevant for the data passed into <tt class="backtick">eddy</tt>. In this case all the volumes in <tt class="backtick">data.nii.gz</tt> are acquired A&gt;&gt;P which means that the first line of <tt class="backtick">acqparams.txt</tt> describes the acquisition for all the volume. We specify that by passing a text file with as many ones as there are volumes in <tt class="backtick">data.nii.gz</tt>. One way of creating such a file would be to type the following commands <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span><p class="line867"><span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><pre><span class="anchor" id="line-1-2"></span>indx=&quot;&quot;
<span class="anchor" id="line-2-2"></span>for ((i=1; i&lt;=64; i+=1)); do indx=&quot;$indx 1&quot;; done
<span class="anchor" id="line-3-1"></span>echo $indx &gt; index.txt</pre><span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line862">where 64 is the total number of volumes in <tt class="backtick">data.nii.gz</tt> and needs to be replaced by the number of volumes in your data. <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span><p class="line862">We are now in a position to run <tt class="backtick">eddy</tt> using the command <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><p class="line867"><span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span><pre><span class="anchor" id="line-1-3"></span>eddy --imain=data --mask=my_hifi_b0_brain_mask --acqp=acqparams.txt --index=index.txt --bvecs=bvecs --bvals=bvals --topup=my_topup_results --out=eddy_corrected_data</pre><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line862">You may be in for quite a long wait as <tt class="backtick">eddy</tt> is quite CPU intensive and also memory hungry. It has been written using OpenMP to take advantage of multiple processors and this may/may not be available to you depending on how it was built in your system. A rule of thumb for how much memory <tt class="backtick">eddy</tt> will use is 8*m*n<sub>x</sub>n<sub>y</sub>n<sub>z</sub> bytes where m is the number of volumes in <tt class="backtick">--imain</tt>, n<sub>x</sub> is the matrix-size in the x-direction, n<sub>y</sub> is the matrix size in the y-direction and n<sub>z</sub> is the number of slices. <span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span><p class="line867">
<h2 id="eddy_with_outlier_replacement">eddy with outlier replacement</h2>
<span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span><p class="line862">When (not if) a subject makes a movement that coincides in time with the diffusion encoding part of the sequence, there will be partial or complete signal dropout. The dropout will affect the whole (the most common case) or parts of a slice. In the presence of out-of-plane rotations these slices will turn into diagonal bands when <tt class="backtick">eddy</tt> rotates the volume back. If uncorrected this will affect any measures derived from the data.  <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><p class="line862">The latest version of <tt class="backtick">eddy</tt> has a mechanism for detecting these dropout-slices and replacing them with Gaussian Process predictions. All one needs to do for example in the example above is to add <tt class="backtick">--repol</tt> to the command line. <span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><p class="line867"><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><pre><span class="anchor" id="line-1-4"></span>eddy --imain=data --mask=my_hifi_b0_brain_mask --acqp=acqparams.txt --index=index.txt --bvecs=bvecs --bvals=bvals --topup=my_topup_results --repol --out=eddy_corrected_data</pre><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span><p class="line862">The exact details of how the outlier replacement is performed can be specified by the user, and in particular if ones data has been acquired with multi-band it can be worth taking a look <a href="./eddy(2f)UsersGuide.html#A--ol_type">here</a>. <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span><p class="line862">The pertinent reference for when using the <tt class="backtick">--repol</tt> functionality is at the main <a class="nonexistent" href="./eddy(2f).html#Referencing">eddy</a> page. <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><div><table><tbody><tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><p class="line862">Example of before and after outlier replacement</td>
</tr>
<tr>  <td><span class="anchor" id="line-93"></span><p class="line891"><img align="left" alt="OLR_before_after.gif" class="attachment" src="attachments/eddy(2f)UsersGuide/OLR_before_after.gif" title="OLR_before_after.gif" width="450" /></td>
</tr>
<tr>  <td style="&amp;quot; text-align: center; &amp;quot;"><span class="anchor" id="line-94"></span><p class="line862">This mini-movie flips between before and after outlier replacement<br>
for two consecutive planes. In the before case one can<br>
clearly see the telltale diagonal bands caused by &quot;missing&quot; slices<br>
 being rotated out of plane. The after case shows how the<br>
missing slices were replaced in the native space before being<br>
 rotated into the reference space (the first volume of <tt class="backtick">--imain</tt>).</td>
</tr>
</tbody></table></div><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span><p class="line867">
<h2 id="Understanding_eddy_output">Understanding eddy output</h2>
<span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><p class="line862">The <a href="./eddy(2f)UsersGuide.html#A--out">--out</a> parameter specifies the basename for all output files of <tt class="backtick">eddy</tt>. It is used as the name for all <tt class="backtick">eddy</tt> output files, but with different extensions. If we assume that user specified <tt class="backtick">--out=my_eddy_output</tt>, the files that are always written are <span class="anchor" id="line-99"></span><span class="anchor" id="line-100"></span><ul><li><p class="line862">my_eddy_output.nii.gz <br>
 This is the main output and consists of the input data after correction for eddy currents and subject movement, and for susceptibility if <tt class="backtick">--topup</tt> or <tt class="backtick">--field</tt> was specified, and for signal dropout if <tt class="backtick">--repol</tt> was set. Chances are this is the only output file you will be interested in (in the context of <tt class="backtick">eddy</tt>). <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span></li><li class="gap"><p class="line862">my_eddy_output.eddy_parameters <br>
 This is a text file with one row for each volume in <tt class="backtick">--imain</tt> and one column for each parameter. The first six columns correspond to subject movement starting with three translations followed by three rotations. The remaining columns pertain to the EC-induced fields and the number and interpretation of them will depend of which EC <a href="./eddy(2f)UsersGuide.html#A--flm">model</a> was specified. <span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span></li><li class="gap"><p class="line862">my_eddy_output.rotated_bvecs <span class="anchor" id="HelpOnRotBvec"></span> <br>
 When a subject moves such that it constitutes a rotation around some axis and this is subsequently reoriented, it will create an inconsistency in the relationship between the data and the &quot;bvecs&quot; (directions of diffusion weighting). This can be remedied by using the <tt class="backtick">my_eddy_output.rotated_bvecs</tt> file for subsequent analysis. For the rotation to work correctly the <tt class="backtick">bvecs</tt> need to be &quot;correct&quot; for FSL before being fed into <tt class="backtick">eddy</tt>. The easiest way to check that this is the case for your data is to run <a href="./FDT.html">FDT</a> and display the _V1 files in <a class="http" href="http://fsl.fmrib.ox.ac.uk/fsl/fslview/">fslview</a> or <a href="./FSLeyes.html">FSLeyes</a> to make sure that the eigenvectors line up across voxels. <span class="anchor" id="line-105"></span><span class="anchor" id="line-106"></span></li><li class="gap"><p class="line862">my_eddy_output.eddy_movement_rms <br>
 A summary of the &quot;total movement&quot; in each volume is created by calculating the displacement of each voxel and then averaging the squares of those displacements across all intracerebral voxels (as determined by <a href="./eddy(2f)UsersGuide.html#A--mask">--mask</a> and finally taking the square root of that. The file has two columns where the first contains the RMS movement relative the first volume and the second column the RMS relative the previous volume. <span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span></li><li class="gap"><p class="line862">my_eddy_output.eddy_restricted_movement_rms <br>
 There is an inherent ambiguity between any EC component that has a non-zero mean across the FOV and subject movement (translation) in the PE direction. They will affect the data in identical (or close to identical if a susceptibility field is specified) ways. That means that both these parameters are estimated by <tt class="backtick">eddy</tt> with large uncertainty. This doesn't matter for the correction of the images, it makes no difference if we estimate a large constant EC components and small movement or if we estimate a small EC component and large movement. The corrected images will be (close to) identical. <em>But</em> it matters if one wants to know how much the subject moved. We therefore supplies this file that estimates the movement RMS as above, but which disregards translation in the PE direction. <span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span></li><li class="gap"><p class="line862">my_eddy_output.eddy_post_eddy_shell_alignment_parameters <br>
 This is a text file with the rigid body movement parameters between the different shells as estimated by a post-hoc mutual information based registration (see <a href="./eddy(2f)UsersGuide.html#A--dont_peas">--dont_peas</a> for details). These parameters will be estimated even if <tt class="backtick">--dont_peas</tt> has been set, but in that case they have not been applied to the corrected images in <tt class="backtick">my_eddy_output.nii.gz</tt>.   <span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span></li><li class="gap"><p class="line862">my_eddy_output.eddy_outlier_report <br>
 This is a text-file with a plain language report on what outlier slices <tt class="backtick">eddy</tt> has found. This file is always created, as are the other <tt class="backtick">my_eddy_output.eddy_outlier_*</tt> files described below, even if the <tt class="backtick">--repol</tt> flag has not been set. Internally <tt class="backtick">eddy</tt> will always detect and replace outliers to make sure they don't affect the estimation of EC/movement, and if <tt class="backtick">--repol</tt> has not been set it will re-introduce the original slices before writing <tt class="backtick">my_eddy_output.nii.gz</tt>. <span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span></li><li class="gap">my_eddy_output.eddy_outlier_map <span class="anchor" id="line-115"></span></li><li>my_eddy_output.eddy_outlier_n_stdev_map <span class="anchor" id="line-116"></span></li><li><p class="line862">my_eddy_output.eddy_outlier_n_sqr_stdev_map <br>
 These are numeric matrices in ASCII format that all have the same general layout. They consist of an initial line of text, after which there is one row for each volume and one column for each slice. Each row corresponding to a b=0 volume is all zeros since <tt class="backtick">eddy</tt> don't consider outliers in these. The meaning of the numbers is different for the three files.  <span class="anchor" id="line-117"></span><ul><li><p class="line862">.eddy_outlier_map <br>
 All numbers are either 0, meaning that scan-slice is not an outliers, or 1 meaning that is is. <span class="anchor" id="line-118"></span></li><li><p class="line862">.eddy_outlier_n_stdev_map <br>
 The numbers denote how many standard deviations off the mean difference between observation and prediction is. <span class="anchor" id="line-119"></span></li><li><p class="line862">.eddy_outlier_n_sqr_stdev_map <br>
 The numbers denote how many standard deviations off the square root of the mean squared difference between observation and prediction is. <span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span></li></ul></li></ul><p class="line862">The following file is only written if the <tt class="backtick">--repol</tt> flag was set. <span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span><ul><li><p class="line862">my_eddy_output.eddy_outlier_free_data.nii.gz <br>
 This is the original data given by <tt class="backtick">--imain</tt> <em>not</em> corrected for susceptibility or EC-induced distortions or subject movement, <em>but</em> with outlier slices replaced by the Gaussian Process predictions. This file is generated for anyone who might want to use <tt class="backtick">eddy</tt> for outlier correction but who want to use some other method to correct for distortions and movement. Though why anyone would want to do that is not clear to us. <span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span></li></ul><p class="line867">
<h1 id="List_of_parameters">List of parameters</h1>
<span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><ul><li>Parameters that specify input files <span class="anchor" id="line-128"></span><span class="anchor" id="line-129"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--imain">--imain=filename</a> <br>
 Name of a file with input images. E.g. <tt class="backtick">all_my_images.nii</tt>. Compulsory. <span class="anchor" id="line-130"></span><span class="anchor" id="line-131"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--mask">--mask=filename</a> <br>
 Name of a file with mask specifying brain vs no-brain. E.g. <tt class="backtick">my_brain_mask.nii</tt>.  Compulsory. <span class="anchor" id="line-132"></span><span class="anchor" id="line-133"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--acqp">--acqp=filename</a> <br>
 Name of text file with information about the acquisition of the images in <tt class="backtick">--imain</tt>. E.g. <tt class="backtick">my_scan_pars.txt</tt>.  Compulsory. <span class="anchor" id="line-134"></span><span class="anchor" id="line-135"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--index">--index=filename</a> <br>
 Name of text file specifying the relationship between the images in --imain and the information in --acqp and --topup. E.g. <tt class="backtick">index.txt</tt>.  Compulsory. <span class="anchor" id="line-136"></span><span class="anchor" id="line-137"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--bvecs">--bvecs=filename</a> <br>
 Name of text-file with <a href="./FDT(2f)UserGuide.html#DTIFIT">normalised diffusion gradients</a>. Compulsory. <span class="anchor" id="line-138"></span><span class="anchor" id="line-139"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--bvals">--bvals=filename</a> <br>
 Name of text-file with <a href="./FDT(2f)UserGuide.html#DTIFIT">b-values</a>. Compulsory. <span class="anchor" id="line-140"></span><span class="anchor" id="line-141"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--topup">--topup=filename</a> <br>
 Name of output from a previous <a href="./topup.html">topup</a> run. Should be the same as the argument given to <tt class="backtick">topup</tt>'s <a class="nonexistent" href="./topup(2f)TopupUsersGuide(2f).html#A--out">--out</a>. Optional. <span class="anchor" id="line-142"></span><span class="anchor" id="line-143"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--field">--field=filename</a> <br>
 Name of image volume representing the susceptibility field. Should be in Hz. Optional. <span class="anchor" id="line-144"></span><span class="anchor" id="line-145"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--field_mat">--field_mat=filename</a> <br>
 Name of rigid body matrix specifying the relative positions of <tt class="backtick">--field</tt> and <tt class="backtick">--imain</tt>. Optional. <span class="anchor" id="line-146"></span><span class="anchor" id="line-147"></span></li></ul></li><li class="gap">Parameters specifying names of output-files <span class="anchor" id="line-148"></span><span class="anchor" id="line-149"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--out">--out=basename</a> <br>
 Basename for output-files. The corrected images will be named <tt class="backtick">&quot;basename&quot;.nii.gz</tt>. Compulsory. <span class="anchor" id="line-150"></span><span class="anchor" id="line-151"></span></li></ul></li><li class="gap"><p class="line862">Parameters specifying how <tt class="backtick">eddy</tt> should be run <span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--flm">--flm=linear/quadratic/cubic</a> <br>
 Spatial model for the field generated by eddy currents. Default <tt class="backtick">quadratic</tt>. <span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--slm">--slm=none/linear/quadratic</a> <br>
 Model for how diffusion gradients generate eddy currents. Default <tt class="backtick">none</tt>. <span class="anchor" id="line-156"></span><span class="anchor" id="line-157"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--fwhm">--fwhm=&quot;fwhm in mm&quot;</a> <br>
 Filter width to use for pre-filtering of data for the estimation process. Default 0. <span class="anchor" id="line-158"></span><span class="anchor" id="line-159"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--niter">--niter=&quot;required number of iterations&quot;</a> <br>
 Specifies how many iterations should be run. Default 5. <span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--fep">--fep</a> <br>
 Fill Empty Planes. Default false. <span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--interp">--interp=spline/trilinear</a> <br>
 Specifies interpolation model during estimation. Default <tt class="backtick">spline</tt>. <span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--resamp">--resamp=jac/lsr</a> <br>
 Specifies final resampling strategy. Default <tt class="backtick">jac</tt>. <span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--nvoxhp">--nvoxhp=&quot;number of voxels&quot;</a> <br>
 Specifies number of voxels to use for GP hyperparameter estimation. Default 1000. <span class="anchor" id="line-168"></span><span class="anchor" id="line-169"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ff">--ff=&quot;number between 1 and 10&quot;</a> <br>
 Fudge factor that imposes Q-space smoothing during estimation. Default 10. <span class="anchor" id="line-170"></span><span class="anchor" id="line-171"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--dont_sep_offs_move">--dont_sep_offs_move</a> <br>
 Do <strong>not</strong> attempt to separate subject movement from field DC component. Default false. <span class="anchor" id="line-172"></span><span class="anchor" id="line-173"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--dont_peas">--dont_peas</a> <br>
 Do <strong>not</strong> end with an alignment of shells to each other. Default false. <span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span></li></ul></li><li class="gap">Parameters pertaining to outlier replacement <span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--repol">--repol</a> <br>
 Replace outliers. Default false. <span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ol_nstd">--ol_nstd</a> <br>
 No. of standard deviations away a slice must be to qualify as an outlier. Default 4. <span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ol_nvox">--ol_nvox</a> <br>
 The minimum no. of intracerebral voxels in a slice to consider it as an outlier. Default 250. <span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ol_type">--ol_type</a> <br>
 Base outlier detection on slices (sw) multi-band groups (mb) or both (both). Default sw. <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ol_pos">--ol_pos</a> <br>
 Consider both positive and negative outliers. Default false. <span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--ol_sqr">--ol_sqr</a> <br>
 Consider outliers in sum-of-squared distribution. Default false. <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--mb">--mb</a> <br>
 Specifies multi-band factor (number of simultaneous slices). Default 1. <span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--mb_offs">--mb_offs</a> <br>
 Specifies missing slices at top or bottom. Default 0. <span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span></li></ul></li><li class="gap">Miscellaneous parameters <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span><ul><li style="list-style-type:none"><p class="line891"><a href="./eddy(2f)UsersGuide.html#A--data_is_shelled">--data_is_shelled</a> <br>
 Do <strong>not</strong> check that data is shelled. Trust the user. Default false. <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><tt class="backtick">--verbose</tt> <br>
 Print progress information to the screen while running. Can be useful to pipe into file before reporting problems <span class="anchor" id="line-198"></span><span class="anchor" id="line-199"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><tt class="backtick">--very_verbose</tt> <br>
 Print very rich progress information to the screen while running. Can be useful to pipe into file before reporting problems <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span></li><li class="gap" style="list-style-type:none"><p class="line891"><tt class="backtick">--help</tt> <br>
 Take a wild stab. <span class="anchor" id="line-202"></span><span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span></li></ul></li></ul><p class="line867">
<h1 id="Parameters_explained">Parameters explained</h1>
<span class="anchor" id="line-205"></span><span class="anchor" id="line-206"></span><p class="line867">
<h2 id="A--imain">--imain</h2>
<span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span><p class="line862">Should specify a 4D image file with <em>all</em> your images acquired as part of a diffusion protocol. I.e. it should contain both your dwis and your <em>b</em>=0 images. If you have collected your data with reversed phase-encode blips, data for both blip-directions should be in this file. <span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span><p class="line867">
<h2 id="A--mask">--mask</h2>
<span class="anchor" id="line-211"></span><span class="anchor" id="line-212"></span><p class="line862">Single volume image file with ones and zeros specifying brain (one) and no-brain (zero). Typically obtained by running <a href="./BET(2f)UserGuide.html">BET</a> on the first <em>b</em>=0 image. If you have previously run <a href="./topup.html">topup</a> on your data I suggest you run <a href="./BET(2f)UserGuide.html">BET</a> on the first volume (or the average of all volumes) of the <a href="./topup(2f)TopupUsersGuide.html#A--iout">--iout</a> output and use that. <span class="anchor" id="line-213"></span><span class="anchor" id="line-214"></span><p class="line867">
<h2 id="A--acqp">--acqp</h2>
<span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span><p class="line862">A text-file describing the acquisition parameters for the different images in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a>. The format of this file is identical to that used by <a class="nonexistent" href="./topup(2f)TopupUsersGuide(2f).html#A--datain">topup</a> (though the parameter is called <tt class="backtick">--datain</tt> there) and described in detail <a href="./eddy(2f)Faq.html#How_do_I_know_what_to_put_into_my_--acqp_file">here</a>. <span class="anchor" id="line-217"></span><span class="anchor" id="line-218"></span><p class="line867">
<h2 id="A--index">--index</h2>
<span class="anchor" id="line-219"></span><span class="anchor" id="line-220"></span><p class="line862">A text-file that determines the relationship between on the one hand the images in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a> and on the other hand the acquisition parameters in <a href="./eddy(2f)UsersGuide.html#A--acqp">--acqp</a> and (optionally) the subject movement information in <a href="./eddy(2f)UsersGuide.html#A--topup">--topup</a>. It should be a single column (or row) with one entry per volume in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a>. We will use a small (simplified) example to make it clear. <span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span><p class="line867"><img align="top" alt="eight_original_images.png" class="attachment" src="attachments/eddy(2f)UsersGuide/eight_original_images.png" title="eight_original_images.png" width="800" /> <span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span><p class="line862">The image above shows a selected slice from each of the eight volumes in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a>. The associated <a href="./eddy(2f)UsersGuide.html#A--acqp">--acqp</a> file is <span class="anchor" id="line-225"></span><span class="anchor" id="line-226"></span><p class="line867"><tt class="backtick">-1&nbsp;0&nbsp;0&nbsp;0.051</tt><br>
<tt class="backtick">1&nbsp;0&nbsp;0&nbsp;0.051</tt> <span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span><p class="line862">which specifies that phase-encoding is performed in the <em>x</em>-direction, sometimes traversing <em>k</em>-space left-&gt;right (-1) and sometimes right-&gt;left (1). Finally the <tt class="backtick">--index</tt> file is <span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><p class="line867"><tt class="backtick">1&nbsp;1&nbsp;1&nbsp;1&nbsp;2&nbsp;2&nbsp;2&nbsp;2</tt> <span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><p class="line862">which specifies that the first four volumes in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a> were acquired using the acquisition parameters on the first row (index 1) of the <a href="./eddy(2f)UsersGuide.html#A--acqp">--acqp</a> file, and that volumes 5--8 were acquired according to the second row (index 2). <span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><p class="line862">There are cases when there may be advantageous to have more than two lines in the <a href="./eddy(2f)UsersGuide.html#A--acqp">--acqp</a> file and in these cases there will be more than two different index values in the <tt class="backtick">--index</tt> file. These cases are explained <a href="./eddy(2f)Faq.html#Why_do_I_need_more_than_two_rows_in_my_--acqp_file">here</a> <span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><p class="line867">
<h2 id="A--bvecs">--bvecs</h2>
<span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span><p class="line862">A text file with normalised vectors describing the direction of the diffusion weighting. This is the same file that you would use for <a href="./FDT(2f)UserGuide.html#DTIFIT">FDT</a>. <span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span><p class="line867">
<h2 id="A--bvals">--bvals</h2>
<span class="anchor" id="line-241"></span><span class="anchor" id="line-242"></span><p class="line862">A text file with <em>b</em>-values () describing the &quot;amount of&quot; diffusion weighting. This is the same file that you would use for <a href="./FDT(2f)UserGuide.html#DTIFIT">FDT</a>. <span class="anchor" id="line-243"></span><span class="anchor" id="line-244"></span><p class="line867">
<h2 id="A--topup">--topup</h2>
<span class="anchor" id="line-245"></span><span class="anchor" id="line-246"></span><p class="line862">This should only be specified if you have previously run <a href="./topup.html">topup</a> on your data and should be the same name that you gave as an argument to the <a href="./topup(2f)TopupUsersGuide.html#A--out">--out</a> parameter when you ran <tt class="backtick">topup</tt>. <span class="anchor" id="line-247"></span><span class="anchor" id="line-248"></span><p class="line867">
<h2 id="A--field">--field</h2>
<span class="anchor" id="line-249"></span><span class="anchor" id="line-250"></span><p class="line862">If there is no <a href="./topup.html">topup</a> output available for your study you may alternatively use a &quot;traditional&quot; fieldmap in its place. This can for example be a dual echo-time fieldmap that has been prepared using <a href="./FUGUE.html">PRELUDE</a>. Note that in contrast to for example <a href="./FUGUE.html">FUGUE</a> it expects the fieldmap to be scaled in Hz. For boring reasons the filename has to be given without an extension. For example <tt class="backtick">--field=my_field</tt>, <strong>not</strong> <tt class="backtick">--field=my_field.nii.gz</tt>. <span class="anchor" id="line-251"></span><span class="anchor" id="line-252"></span><p class="line867"><img alt="/!\" height="15" src="/fsl/wiki_static/fsl/img/alert.png" title="/!\" width="15" /> There are two important caveats with <tt class="backtick">--field</tt>, which is why we strongly recommend using a <a href="./topup.html">topup</a> derived field if at all possible. These are <span class="anchor" id="line-253"></span><ul><li><p class="line862">If one uses the same <a href="./eddy(2f)Faq.html#How_do_I_know_what_to_put_into_my_--acqp_file">--acqp</a> file for both <tt class="backtick">topup</tt> and <tt class="backtick">eddy</tt> it doesn't matter if one get the total acquisition time or the PE-polarity wrong. The errors in <tt class="backtick">topup</tt> and <tt class="backtick">eddy</tt> will cancel out and the end results will still be correct. Our experience is that getting these two numbers right is the biggest problem with using <a href="./FUGUE.html">FUGUE</a>. <span class="anchor" id="line-254"></span></li><li><p class="line862">If the first volume input to <tt class="backtick">topup</tt> is the same as the first volume in <a href="./eddy(2f)UsersGuide.html#A--imain">--imain</a> to <tt class="backtick">eddy</tt>, the fieldmap will automatically be in the reference space of <tt class="backtick">eddy</tt>. When using the <tt class="backtick">--field</tt> option the user is responsible for making sure the fieldmap is registered to the <tt class="backtick">eddy</tt> data. <span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span></li></ul><p class="line867">
<h2 id="A--field_mat">--field_mat</h2>
<span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span><p class="line862">Specifies a <a class="nonexistent" href="./flirt.html">flirt</a> style rigid body matrix that specifies the relative locations of the field specified by <tt class="backtick">--field</tt> and the first volume in the file specified by <tt class="backtick">--imain</tt>. If <tt class="backtick">my_field</tt> is the field specified by <tt class="backtick">--field</tt>, <tt class="backtick">my_ima</tt> is the first volume of <tt class="backtick">--imain</tt> and <tt class="backtick">my_mat</tt> is the matrix specified by <tt class="backtick">--field_mat</tt>. Then the command <tt class="backtick">flirt&nbsp;-ref&nbsp;my_ima&nbsp;-in&nbsp;my_field&nbsp;-init&nbsp;my_mat&nbsp;-applyxfm</tt> should be the command that puts <tt class="backtick">my_field</tt> in the space of <tt class="backtick">my_ima</tt>. <span class="anchor" id="line-259"></span><span class="anchor" id="line-260"></span><p class="line867">
<h2 id="A--out">--out</h2>
<span class="anchor" id="line-261"></span><span class="anchor" id="line-262"></span><p class="line862">Specifies the basename of the output. Let us say <tt class="backtick">--out=&quot;basename&quot;</tt>. The output will then consist of a 4D image file named <tt class="backtick">&lt;basename&gt;.nii.gz</tt> containing all the corrected volumes and a text-file named <tt class="backtick">&lt;basename&gt;.eddy_parameters</tt> with parameters defining the field and movement for each scan. <span class="anchor" id="line-263"></span><span class="anchor" id="line-264"></span><p class="line867">
<h2 id="A--flm">--flm</h2>
<span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span><p class="line862">This parameter takes the values <tt class="backtick">linear</tt>, <tt class="backtick">quadratic</tt> or <tt class="backtick">cubic</tt>. It specifies how &quot;complicated&quot; we believe the eddy current-induced fields may be.  <span class="anchor" id="line-267"></span><span class="anchor" id="line-268"></span><p class="line862">Setting it to <tt class="backtick">linear</tt> implies that we think that the field caused be eddy currents will be some combination of linear gradients in the x-, y- and z-directions. It is this model that is the basis for the claim &quot;eddy current distortions is a combination of shears, a zoom and a translation&quot;. It is interesting (and surprising) how successful this model has been in describing (and correcting) eddy current distortions since not even the fields we intend to be linear (<em>i.e.</em> our gradients) are particularly linear on modern scanners. <span class="anchor" id="line-269"></span><span class="anchor" id="line-270"></span><p class="line862">The next model in order of &quot;complication&quot; is <tt class="backtick">quadratic</tt> which assumes that the eddy current induced field can be modelled as some combination of linear and quadratic terms (x, y, z, x<sup>2</sup>, y<sup>2</sup>, z<sup>2</sup>, xy, xz and yz). This is almost certainly also a vast oversimplification but our practical experience has been that this model successfully corrects for example the HCP data (which is not well corrected by the <tt class="backtick">linear</tt> model). <span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span><p class="line862">The final model is <tt class="backtick">cubic</tt> which in addition to the terms in the <tt class="backtick">quadratic</tt> model also has cubic terms (x<sup>3</sup>, x<sup>2</sup>y, etc). We have yet to find a data set where the <tt class="backtick">cubic</tt> model performs significantly better than the <tt class="backtick">quadratic</tt> one. Note also that the more complicated the model the longer will <tt class="backtick">eddy</tt> take to run. <span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span><p class="line867">
<h2 id="A--slm">--slm</h2>
<span class="anchor" id="line-275"></span><span class="anchor" id="line-276"></span><p class="line862">&quot;Second level model&quot; that specifies the mathematical form for how the diffusion gradients cause eddy currents. For high quality data with 60 directions, or more, sampled on the whole sphere we have not found any advantage of performing second level modelling. Hence our recommendation for such data is to use <tt class="backtick">none</tt>, and that is also the default. <span class="anchor" id="line-277"></span><span class="anchor" id="line-278"></span><p class="line862">If the data has quite few directions and/or is has not been sampled on the whole sphere it can be advantageous to specify <tt class="backtick">--slm=linear</tt>. <span class="anchor" id="line-279"></span><span class="anchor" id="line-280"></span><p class="line867">
<h2 id="A--fwhm">--fwhm</h2>
<span class="anchor" id="line-281"></span><span class="anchor" id="line-282"></span><p class="line874">Specifies the FWHM of a gaussian filter that is used to pre-condition the data before using it to estimate the distortions. In general the accuracy of the correction is not strongly dependent on the FWHM. Empirical tests have shown that ~1-2mm might be best, but by so little that the default has been left at 0.  <span class="anchor" id="line-283"></span><span class="anchor" id="line-284"></span><p class="line862">One exception is when there is substantial subject movement, which may mean that <tt class="backtick">eddy</tt> fails to converge in 5 iterations if run with <tt class="backtick">fwhm=0</tt>. In such cases we have found that <tt class="backtick">--fwhm=10,0,0,0,0</tt> works well. It means that the first iteration is run with a FWHM of 10mm, which helps that algorithm to take a big step towards the true solution. The remaining iterations are run with a FWHM of 0mm, which offers high accuracy. <span class="anchor" id="line-285"></span><span class="anchor" id="line-286"></span><p class="line867">
<h2 id="A--niter">--niter</h2>
<span class="anchor" id="line-287"></span><span class="anchor" id="line-288"></span><p class="line867"><tt class="backtick">eddy</tt> does not check for convergence. Instead it runs a fixed number of iterations given by <tt class="backtick">--niter</tt>. This is not unusual for registration algorithms where each iteration is expensive (i.e. takes long time). Instead we run it for a fixed number of iterations, 5 as default. <span class="anchor" id="line-289"></span><span class="anchor" id="line-290"></span><p class="line862">If, on visual inspection, one finds residual movement or EC-induced distortions it is possible that <tt class="backtick">eddy</tt> has not fully converged. In that case we primarily recommend that one uses <tt class="backtick">--fwhm=10,0,0,0,0</tt>, as described above, to speed up convergence. Only if that fails do we recommend increasing the number of iterations. <span class="anchor" id="line-291"></span><span class="anchor" id="line-292"></span><p class="line867">
<h2 id="A--fep">--fep</h2>
<span class="anchor" id="line-293"></span><span class="anchor" id="line-294"></span><p class="line874">Stands for &quot;Fill Empty Planes&quot;. For reasons that are not completely clear to us the reconstructed EPI images from some manufacturers contain one or more empty &quot;planes&quot;. A &quot;plane&quot; in this context do not necessarily mean a &quot;slice&quot;. Instead it can be for example the &quot;plane&quot; that constitutes the last voxel along the PE-direction for each &quot;PE-direction column&quot;. The presence/absence of these &quot;empty planes&quot; seems to depend on the exact details of image encoding part of the sequence. <span class="anchor" id="line-295"></span><span class="anchor" id="line-296"></span><p class="line862">IF <tt class="backtick">--fep</tt> is set <tt class="backtick">eddy</tt> will attempt to identify the empty planes and &quot;fill them in&quot;. The filling will consist of duplicating the previous plane if the plane is perpendicular to the frequency-encode direction and by interpolation between the previous and the &quot;wrap-around plane&quot; if the plane is perpendicular to the PE-direction . <span class="anchor" id="line-297"></span><span class="anchor" id="line-298"></span><p class="line867">
<h2 id="A--interp">--interp</h2>
<span class="anchor" id="line-299"></span><span class="anchor" id="line-300"></span><p class="line862">Specifies the interpolation model used during the estimation phase, and during the final resampling if --resamp=jac is used. We strongly recommend staying with <tt class="backtick">spline</tt>, which is also the default. <span class="anchor" id="line-301"></span><span class="anchor" id="line-302"></span><p class="line867">
<h2 id="A--resamp">--resamp</h2>
<span class="anchor" id="line-303"></span><span class="anchor" id="line-304"></span><p class="line874">Specifies how the final resampling is performed. The options are <span class="anchor" id="line-305"></span><ul><li><p class="line862">jac: Stands for Jacobian modulation. This is a &quot;traditional&quot; type of interpolation (spline or trilinear depending on the <tt class="backtick">--interp</tt> parameter) combined with Jacobian modulation to account for signal pile-up/dilution caused by local stretching/compression. However, in areas of compression (resulting in signal pile-up) there is a loss of resolution that this type of resampling cannot resolve. If acquisitions have not been repeated with opposed PE-directions, this is the only option that can be used. <span class="anchor" id="line-306"></span></li><li>lsr: Stands for Least-Squares Reconstruction. This method attempts to use the complimentary information in images acquired with opposing PE-directions, where a compressed area in one of the images will be stretched in the other image. This method can only be used if all acquisitions have been repeated with opposed PE-directions. <span class="anchor" id="line-307"></span><span class="anchor" id="line-308"></span></li></ul><p class="line867">
<h2 id="A--nvoxhp">--nvoxhp</h2>
<span class="anchor" id="line-309"></span><span class="anchor" id="line-310"></span><p class="line874">Specifies how many (randomly selected within the brain mask) voxels that are used when estimating the hyperparameters of the Gaussian Process used to make predictions. The default is 1000 voxels, and that is more than sufficient for typical data with resolution of 2x2x2mm or lower. For very high resolution data, such as for example the HCP 7T data, with relatively low voxel-wise SNR one may need to increase this number. The only &quot;adverse&quot; effect of increasing this number is an increase in execution time. <span class="anchor" id="line-311"></span><span class="anchor" id="line-312"></span><p class="line867">
<h2 id="A--ff">--ff</h2>
<span class="anchor" id="line-313"></span><span class="anchor" id="line-314"></span><p class="line874">This should be a number between 1 and 10 and determines the level of Q-space smoothing that is used by the prediction maker during the estimation of the movement/distortions. Empirical testing has indicated that any number above 5 gives best results. We have set the default to 10 to be on the safe side. <span class="anchor" id="line-315"></span><span class="anchor" id="line-316"></span><p class="line867">
<h2 id="A--dont_sep_offs_move">--dont_sep_offs_move</h2>
<span class="anchor" id="line-317"></span><span class="anchor" id="line-318"></span><p class="line862">All our models for the EC-field contains a component that is constant across the field and that results in a translation of the object in the PE-direction. Depending on how the data has been acquired it can be more or less difficult to distinguish between this constant component and subject movement. It matters because it affects how the diffusion weighted images are aligned with the <em>b</em>=0 images. Therefore eddy attempts to distinguish the two by fitting a second level model to the estimated constant component, and everything that is not explained by that model will be attributed to subject movement.  <span class="anchor" id="line-319"></span><span class="anchor" id="line-320"></span><p class="line862">If you set this flag <tt class="backtick">eddy</tt> will <strong>not</strong> do that estimation. The option to turn this off is a remnant from when we did not know how well it would work and it is very unlikely you will ever use this flag. It will eventually be deprecated. <span class="anchor" id="line-321"></span><span class="anchor" id="line-322"></span><p class="line867">
<h2 id="A--dont_peas">--dont_peas</h2>
<span class="anchor" id="line-323"></span><span class="anchor" id="line-324"></span><p class="line862">The motion correction within <tt class="backtick">eddy</tt> has greatest precision within a shell and has a bigger uncertainty between shells. There is <em>no</em> estimation of movement between the first <em>b</em>=0 volume and the first diffusion weighted volume. Instead is is assumed that these have been acquired very close in time and that there were no movement between them. <span class="anchor" id="line-325"></span><span class="anchor" id="line-326"></span><p class="line862">If there are multiple shells or if the assumption of no movement between the first <em>b</em>=0 and the first diffusion weighted volume is not fulfilled it can be advantageous to perform a &quot;Post Eddy Alignment of Shells&quot; (<tt class="backtick">peas</tt>). Our testing indicates that the <tt class="backtick">peas</tt> has an accuracy of ~0.2-0.3mm, <em>i.e.</em> it is associated with some uncertainty. This precision is still such that <tt class="backtick">peas</tt> is performed as default. <span class="anchor" id="line-327"></span><span class="anchor" id="line-328"></span><p class="line867"><em>But</em>, if one has a data set with a single shell (<em>i.e.</em> a single non-zero shell) <em>and</em> the assumption of no movement between the first <em>b</em>=0 and the first diffusion weighted image is true it can be better to avoid that uncertainty. And in that case it may be better to turn off <tt class="backtick">peas</tt> by setting the <tt class="backtick">--dont_peas</tt> flag. <span class="anchor" id="line-329"></span><span class="anchor" id="line-330"></span><p class="line867">
<h2 id="A--repol">--repol</h2>
<span class="anchor" id="line-331"></span><span class="anchor" id="line-332"></span><p class="line862">When set this flag instructs <tt class="backtick">eddy</tt> to remove any slices deemed as outliers and replace them with predictions made by the Gaussian Process. Exactly what constitutes an outlier is affected by the parameters <a href="./eddy(2f)UsersGuide.html#A--ol_nstd">--ol_nstd</a>, <a href="./eddy(2f)UsersGuide.html#A--ol_nvox">--ol_nvox</a>, <a href="./eddy(2f)UsersGuide.html#A--ol_type">--ol_type</a>, <a href="./eddy(2f)UsersGuide.html#A--ol_pos">--ol_pos</a> and <a href="./eddy(2f)UsersGuide.html#A--ol_sqr">--ol_sqr</a>. If the defaults are used for all those parameters an outlier is defined as a slice whose average intensity is at least four standard deviations lower than the expected intensity, where the expectation is given by the Gaussian Process prediction. <span class="anchor" id="line-333"></span><span class="anchor" id="line-334"></span><p class="line862">The default is to <em>not</em> do outlier replacement since we don't want to risk people using it &quot;unawares&quot;. However, our experience and tests indicate that it is always a good idea to use <tt class="backtick">--repol</tt>. <span class="anchor" id="line-335"></span><span class="anchor" id="line-336"></span><p class="line867">
<h2 id="A--ol_nstd">--ol_nstd</h2>
<span class="anchor" id="line-337"></span><span class="anchor" id="line-338"></span><p class="line874">This parameter determines how many standard deviations away a slice need to be in order to be considered an outlier. The default value of 4 is a good compromise between type 1 and 2 errors for a &quot;standard&quot; data set of 50-100 directions. Our tests also indicate that the parameter is not terribly critical and that any value between 3 and 5 is good for such data. For data of very high quality, such as for example HCP data with 576 dwi volumes, one can use a higher value (for example 5). Conversely, for data with few directions a lower threshold can be used. <span class="anchor" id="line-339"></span><span class="anchor" id="line-340"></span><p class="line867">
<h2 id="A--ol_nvox">--ol_nvox</h2>
<span class="anchor" id="line-341"></span><span class="anchor" id="line-342"></span><p class="line862">This parameter determines the minimum number of intracerebral voxels a slice need to have in order to be considered in the outliers estimation. Consider for example a slice at the very top of the brain with only ten brain voxels. The average (based on only ten voxels) difference from the prediction will be very poorly estimated and to try to determine if it was an outlier or not on that basis would be very uncertain. For that reason there is a minimum number of brain voxels (as determined by the <tt class="backtick">--mask</tt>) for a slice to be considered. The default is 250. <span class="anchor" id="line-343"></span><span class="anchor" id="line-344"></span><p class="line867">
<h2 id="A--ol_type">--ol_type</h2>
<span class="anchor" id="line-345"></span><span class="anchor" id="line-346"></span><p class="line862">The normal behaviour for <tt class="backtick">eddy</tt> is to consider each slice in isolation when assessing outliers. When acquiring multi-band (mb) data each slice in the group will have a similar signal dropout when it is caused by gross subject movement (as opposed to pulsatile movement of <em>e.g.</em> the brain stem). It therefore makes sense to consider an mb-group as the unit when assessing outliers. There are therefore three options for the unit of outliers. <span class="anchor" id="line-347"></span><ul><li>Slice-wise (sw) is the default and most basic way of estimating outliers. <span class="anchor" id="line-348"></span></li><li>Group-wise (gw) considers an mb-group as the outlier unit. <span class="anchor" id="line-349"></span></li><li>Both (both) considers an mb-group as the unit, but additionally looks for slice-wise outliers. This is to find single slices within a group that has been affected by pulsatile movement not affecting the other slices. <span class="anchor" id="line-350"></span></li></ul><p class="line862">Default is <tt class="backtick">sw</tt>.  <span class="anchor" id="line-351"></span><span class="anchor" id="line-352"></span><p class="line867">
<h2 id="A--ol_pos">--ol_pos</h2>
<span class="anchor" id="line-353"></span><span class="anchor" id="line-354"></span><p class="line862">By default eddy only considers signal dropout, <em>i.e.</em> the negative end of the distribution of differences. One could conceivably also have positive outliers, <em>i.e.</em> slices where the signal is greater than expected. This could for example be caused by spiking or other acquisition related problems. If one wants to detect and remove this type of outliers one can use the <tt class="backtick">--ol_pos</tt> flag. <span class="anchor" id="line-355"></span><span class="anchor" id="line-356"></span><p class="line874">In general we don't encourage its use since we believe that type of artefacts should be detected and corrected at source. We have looked a large number of FMRIB and HCP data sets and not found a single believable positive outlier. <span class="anchor" id="line-357"></span><span class="anchor" id="line-358"></span><p class="line867">
<h2 id="A--ol_sqr">--ol_sqr</h2>
<span class="anchor" id="line-359"></span><span class="anchor" id="line-360"></span><p class="line862">Similarly to the <tt class="backtick">--ol_pos</tt> flag above it extends the scope of outliers that <tt class="backtick">eddy</tt> considers. If the <tt class="backtick">--ol_sqr</tt> flag is set <tt class="backtick">eddy</tt> will look for outliers also in the distribution of &quot;sums of squared differences between observations and predictions&quot;. This means it will detect also artefacts that doesn't cause a change in mean intensity. <span class="anchor" id="line-361"></span><span class="anchor" id="line-362"></span><p class="line862">Similarly to <tt class="backtick">--ol_pos</tt> we don't encourage the use of <tt class="backtick">--ol_sqr</tt>. Artefacts that fall into this category should be identified and the causes corrected at the acquisition stage. <span class="anchor" id="line-363"></span><span class="anchor" id="line-364"></span><p class="line867">
<h2 id="A--mb">--mb</h2>
<span class="anchor" id="line-365"></span><span class="anchor" id="line-366"></span><p class="line862">If <tt class="backtick">--ol_type=gw</tt> or <tt class="backtick">--ol_type=both</tt> <tt class="backtick">eddy</tt> needs to know how the multi-band groups were acquired and to that end <tt class="backtick">--mb</tt> has to be set. If for example the total number of slices is 15 and <tt class="backtick">mb=3</tt> it will be assumed that slices 0,5,10 were acquired as one group, 1,6,11 as the next group etc (slices numbered 0,1,...14). <span class="anchor" id="line-367"></span><span class="anchor" id="line-368"></span><p class="line867"><img alt="/!\" height="15" src="/fsl/wiki_static/fsl/img/alert.png" title="/!\" width="15" /> The next version of <tt class="backtick">eddy</tt> will need a more detailed description of the multi-band structure, so <tt class="backtick">--mb_offs</tt> is likely to be deprecated in the future. <span class="anchor" id="line-369"></span><span class="anchor" id="line-370"></span><p class="line867">
<h2 id="A--mb_offs">--mb_offs</h2>
<span class="anchor" id="line-371"></span><span class="anchor" id="line-372"></span><p class="line862">If a slice has been removed at the top or bottom of the volumes in <tt class="backtick">--imain</tt> the group structure given by <tt class="backtick">--mb</tt> will no longer hold. If the bottom slice has been removed <tt class="backtick">--mb_offs</tt> should be set to <tt class="backtick">--mb_offs=-1</tt>. For the example above it would mean that the first group of slices would consist of slices 4,9 and the second group of 0,5,10 where the slice numbering refers to the new (with missing slice) volume numbered 0,1,13. Correspondingly, if the top slice was removed it should be set to 1. <span class="anchor" id="line-373"></span><span class="anchor" id="line-374"></span><p class="line867"><img alt="/!\" height="15" src="/fsl/wiki_static/fsl/img/alert.png" title="/!\" width="15" /> The next version of <tt class="backtick">eddy</tt> will need a more detailed description of the multi-band structure, so <tt class="backtick">--mb_offs</tt> is likely to be deprecated in the future. <span class="anchor" id="line-375"></span><span class="anchor" id="line-376"></span><p class="line867">
<h2 id="A--data_is_shelled">--data_is_shelled</h2>
<span class="anchor" id="line-377"></span><span class="anchor" id="line-378"></span><p class="line862">At the moment <tt class="backtick">eddy</tt> works for single- or multi-shell diffusion data, <em>i.e.</em> it doesn't work for DSI data. In order to ensure that the data is shelled `eddy &quot;checks it&quot;, and only proceeds if it is happy that it is indeed shelled. The checking is performed through a set of heuristics such as i) how many shells are there? ii) what are the absolute numbers of directions for each shell? iii) what are the relative numbers of directions for each shell? etc. It will for example be suspicious of too many shells, too few directions for one of the shells etc. <span class="anchor" id="line-379"></span><span class="anchor" id="line-380"></span><p class="line862">It has emerged that some popular schemes get caught in this test. Some groups will for example acquire a &quot;mini shell&quot; with low <em>b</em>-value and few directions and that has failed to pass the &quot;check&quot;, even though it turns out <tt class="backtick">eddy</tt> works perfectly well on the data. For that reason we have introduced the <tt class="backtick">--data_is_shelled</tt> flag. <span class="anchor" id="line-381"></span><span class="anchor" id="line-382"></span><p class="line862">If set, it will bypass any checking and <tt class="backtick">eddy</tt> will proceed as if data was shelled. Please be aware that if you have to use this flag you may be in untested territory and that it is a good idea to check your data extra carefully after having run <tt class="backtick">eddy</tt> on it. <span class="anchor" id="line-383"></span><span class="anchor" id="line-384"></span><p class="line867">
<h2 id="A--verbose">--verbose</h2>
<span class="anchor" id="line-385"></span><span class="anchor" id="line-386"></span><p class="line874">Turns on printing of information about the algorithms progress to the screen. <span class="anchor" id="line-387"></span><span class="anchor" id="line-388"></span><p class="line867">
<h2 id="A--help">--help</h2>
<span class="anchor" id="line-389"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:30
</body>
</html>
