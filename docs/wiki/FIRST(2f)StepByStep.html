<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>FIRST/StepByStep</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="fsl/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="fsl/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="fsl/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">FIRST/StepByStep</a>
</ul>
<br><br>
[<a href="FSL.html">FSL</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line874">FIRST is FSL’s tool for automatic segmentation of a number of subcortical structures. The supported structures are: <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><ul><li>Putamen (Puta) <span class="anchor" id="line-6"></span></li><li>Caudate nucleus (Caud) <span class="anchor" id="line-7"></span></li><li>Nucleus accumbens (Accu) <span class="anchor" id="line-8"></span></li><li>Globus pallidus (Pall) <span class="anchor" id="line-9"></span></li><li>Hippocampus (Hipp) <span class="anchor" id="line-10"></span></li><li>Amygdala (Amyg) <span class="anchor" id="line-11"></span></li><li>Thalamus (Thal) <span class="anchor" id="line-12"></span></li><li><p class="line862">Brainstem (BrStem) <span class="anchor" id="line-13"></span><span class="anchor" id="line-14"></span></li></ul><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-15"></span>The abbreviated names in parenthesis are the names that FIRST uses. To segment these structures, FIRST needs a good quality T1-weighted image. Such an image is included in most studies, as it is typically also used for registration purposes. <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line867">
<h2 id="Running_FIRST_for_a_single_subject">Running FIRST for a single subject</h2>
<span class="anchor" id="line-18"></span><p class="line874">Only a single command is required to segment all of the required structures with default options (which is recommended). It is important to inspect the output afterwards, however, and this is also part of the step-by-step guide. <span class="anchor" id="line-19"></span><span class="anchor" id="line-20"></span><ol type="1"><li>Run FIRST with the command: <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><span class="anchor" id="line-23"></span><pre><span class="anchor" id="line-1"></span>run_first_all -d -i &lt;name of your t1 image&gt; -o &lt;output name&gt;</pre><span class="anchor" id="line-24"></span><ul><li>If your input file is already brain-extracted, i.e. it is the output from bet, add the -b option. The option -d prevents FIRST from deleting the masks for individual structures - if you will not use these files, you can remove the option. <span class="anchor" id="line-25"></span></li><li>The output name is used as a prefix for the segmentation output; the subject ID might be a good choice. For example, specifying -o 0002 would generate a left hippocampus segmentation called 0002_L_Hipp_first.vtk, a right putamen segmentations called 0002_R_Puta_first.vtk and so forth. <span class="anchor" id="line-26"></span></li><li>Note that the output from the registration step uses filenames derived from the name of the input images, so if you specify a different directory using -o, these files will end up in the directory of the input image. <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span></li></ul></li><li class="gap"><p class="line862">After FIRST has completed, inspect the segmentations that it produced. To do this, load your original T1-weighted image in fslview and overlay the file<strong><br>
&lt;your output name&gt;_all_fast_firstseg.nii.gz.</strong> <span class="anchor" id="line-29"></span><ul><li>This is a 3D file containing the final segmentations after full boundary correction, which ensures that structures do not overlap. This file is very useful as a quick overview of all the segmentations that FIRST produced. Use the MGH-Subcortical color map in fslview (this is normally selected automatically). By toggling the visibility of the segmentation masks, you can check the quality of the segmentations. <span class="anchor" id="line-30"></span><span class="anchor" id="line-31"></span></li></ul></li><li class="gap">In addition to these segmentation masks, a number of other files should have been created by first. The most important ones are: <span class="anchor" id="line-32"></span><ul><li><p class="line891"><strong>&lt;your output name&gt;_all_fast_origsegs.nii.gz</strong><br>
 <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span></li><li class="gap"><p class="line862">This is a 4D image in which each 3D volume is the segmentation mask for one of the structures. The intensities in the image correspond to the label for each structure as listed at the end of the FIRST user guide, which can be found in the <a class="http" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FIRST/UserGuide">FIRST User Guide</a>. Note that boundary voxels have 100 added to their intensity - this is just for visualisation. Segmentations are generated in the native coordinate system of the original image and can be overlaid in fslview. The segmentations can be subtly different from those in the _firstseg.nii.gz file, as boundary correction has not been applied to the _origsegs.nii.gz segmentations. <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></li><li class="gap"><p class="line891"><strong>&lt;your output name&gt;_X_YYYY_first.bvars </strong>and<strong> &lt;your output name&gt;_X_YYYY_first.vtk</strong><br>
 <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></li><li class="gap">These are the other main segmentation output files, obtained by segmenting the different structures independently. In the filenames, X is the hemisphere and YYYY is the name of the structure (see the list above). The .bvars files contain the model parameters and are used for shape analysis, which will be described in the next section, while the .vtk files can be used for 3D visualisation in fslview. <span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span></li><li class="gap"><p class="line891"><strong>&lt;your input image filename&gt;_T1w_to_std_sub.mat </strong>and <strong>&lt;your input image filename&gt;_T1w_to_std_sub.nii.gz</strong><br>
 <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span></li><li class="gap">The .mat file is the affine matrix found during registration using first_flirt, which is optimised for the subcortical structures. The .nii.gz is the input image registered to the template using that transform. These files can be useful in diagnosing problems - if the segmentation is wildly off, registration is one of the first things to look at. <span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span></li><li class="gap"><p class="line891"><strong>&lt;your output name&gt;_X_YYYY_first.nii.gz </strong>and<strong> &lt;your output name&gt;_X_YYYY_corr.nii.gz</strong><br>
 <span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span></li><li class="gap">These files are the masks corresponding to the parameters stored in the .bvars file. The _first.nii.gz is the original output, while the _corr.nii.gz files may have had boundary correction applied to them (this depends on the structure). These files are deleted by FIRST if the -d option is not used. <span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span></li></ul></li></ol><p class="line867"><hr /><p class="line874"> <span class="anchor" id="line-49"></span>
<h2 id="Performing_a_vertex_.28group.29_analysis_with_FIRST">Performing a vertex (group) analysis with FIRST</h2>
<span class="anchor" id="line-50"></span><p class="line874">This section describes how to perform a vertex analysis, which is the ‘standard’ group-level analysis for FIRST. <span class="anchor" id="line-51"></span><span class="anchor" id="line-52"></span><ol type="1"><li><p class="line862">Run FIRST on all of your subjects’ data. The user guide on the FSL wiki has some tips on structuring your data directory and filenames. Once you have decided on data organisations, run <strong>run_first_all</strong> on all of the datasets; the wiki also contains some tips for scripting this. For a description of the output files, see the single-subject step-by-step guide. <span class="anchor" id="line-53"></span><span class="anchor" id="line-54"></span></li><li class="gap">Check that FIRST produced good quality segmentations. The quickest way to do this is to run <span class="anchor" id="line-55"></span><span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span><pre><span class="anchor" id="line-1-1"></span>first_roi_slicesdir &lt;names of T1 images&gt; &lt;names of masks for a structure&gt;</pre><span class="anchor" id="line-58"></span><ul><li>An actual command line might look something like this: <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><span class="anchor" id="line-61"></span><pre><span class="anchor" id="line-1-2"></span>first_roi_slicesdir subj??_struc.nii.gz subj??-L_Caud_first.nii.gz</pre><span class="anchor" id="line-62"></span><span class="anchor" id="line-63"></span></li><li class="gap">This generates a webpage that shows the mask for the left caudate nucleus overlaid on the T1 volume for each subject. Open the slicesdir/index.html file in your web browser to view the report. Note that in the first example we used the non-boundary corrected files, as these are closest to the segmentations that are used for vertex analysis. If you want to generate another report for a different structure, rename slicesdir first, as the output is always given that name! This step is one of the reasons that we used the -d option - otherwise the masks for individual structures would have been deleted by FIRST. <span class="anchor" id="line-64"></span></li><li>To look at all structures at once, you can use the command <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span><pre><span class="anchor" id="line-1-3"></span>first_roi_slicesdir subj??_struc.nii.gz subj??-all_fast_firstseg.nii.gz</pre><span class="anchor" id="line-68"></span><ul><li style="list-style-type:none">These images may be harder to assess, so if you are only interested in one or two structures, it is probably a good idea to examine these in isolation using the commands above. <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span></li></ul></li><li class="gap">To have a closer look at the segmentations, use fslview as described in the single subject guide. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span></li></ul></li><li class="gap"><p class="line862">You are now ready to set up your group analysis. The statistical analysis will be performed using randomise, FSL’s tool for non-parametrical inference. You will need to set up a general linear model (GLM) that corresponds to the design of your experiment - use the Glm or Glm_gui (on Mac) graphical interface (select ‘higher level’) to generate the necessary files. A list of examples, as well as a link to a set of intro slides, is provided on this wiki: <a class="http" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM">http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM</a> <span class="anchor" id="line-73"></span><ul><li>One of the simplest and most commonly used models is an unpaired t-test for the difference in means between two groups. This is explained at the top of the wiki page and can be set up automatically using the command: <span class="anchor" id="line-74"></span></li><li style="list-style-type:none"><span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><pre><span class="anchor" id="line-1-4"></span>design_ttest2 &lt;output design name&gt; &lt;size of first group&gt; &lt;size of second group&gt;</pre><span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span></li><li class="gap" style="list-style-type:none">This will generate two files with the output name and extensions .mat and .con. The first file is the design matrix and the second one specifies the contrasts. <span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span></li></ul></li><li class="gap">As randomise cannot read the .bvars files that contain the parameters of the shapes, these files need to be converted to a form that it can use. This is done using the commands: <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span><span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><pre><span class="anchor" id="line-1-5"></span>concat_bvars concatenated.bvars &lt;list of .bvars files&gt;
<span class="anchor" id="line-2"></span>
<span class="anchor" id="line-3"></span>first_utils --vertexAnalysis --usebvars --useReconNative -- useRigidAlign -i concatenated.bvars -d &lt;design&gt;.mat -o &lt;output name&gt;</pre><span class="anchor" id="line-86"></span><ul><li>The list of .bvars files should list all subjects in the order in which they need to be included in the design matrix. It is a good idea to have your filenames differ only by a numerical subject ID as this will allow you to specify a pattern like subj????.bvars - this will automatically be expanded to all matching filenames in alphabetical (and numerical) order. If you have two groups, you can specify a pattern like control????.bvars patient????.bvars. To see what files will be filled in before running the command, you can prepend “echo “ to the command line to check. <span class="anchor" id="line-87"></span></li><li>The second command (first_utils) creates a 4D nifti file with one volume per subject. In each volume, the amount by which the surface of the shape was moved outwards or inwards for the corresponding subject is stored in the voxel values along the outline of the shape. Note that this outline is the same for all subjects, to enable randomise to do per-voxel statistics. See the wiki for a more detailed description of this process and for information on the difference between --useReconNative (also specify --useRigidAlign if you use this) and --useReconMNI. This is quite an important issue as it determines whether brain size is removed from the reconstructions or not. <span class="anchor" id="line-88"></span></li><li><p class="line862">After this step, you should have two output files, &lt;output name&gt;.nii.gz and &lt;output name&gt;_mask.nii.gz, which you can feed into randomise. <span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span></li></ul></li><li class="gap">Run the statistics with the command (name is the output name from the previous step) <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span><span class="anchor" id="line-93"></span><pre><span class="anchor" id="line-1-6"></span>randomise -i &lt;name&gt;.nii.gz -m &lt;name&gt;_mask.nii.gz -o &lt;design&gt;_randomise -d &lt;design&gt;.mat -t &lt;design&gt;.con --T2</pre><span class="anchor" id="line-94"></span><ul><li>The option --T2 tells randomise to use 2D-optimised TFCE multiple comparisons correction, which is appropriate as the data are on a surface. See the wiki for information on how to run randomise if your design contains F-contrasts. <span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span></li></ul></li><li class="gap">To view the results, overlay the *_tfce_corrp_tstat?.nii.gz files on the mask. For example: <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span><span class="anchor" id="line-99"></span><pre><span class="anchor" id="line-1-7"></span>fslview &lt;name&gt;_mask.nii.gz $FSLDIR/data/standard/MNI152_T1_1mm_brain - b 0,1 -l Green &lt;name&gt;_tfce_corrp_tstat1.nii.gz -l Red-Yellow -b 0.95,1 &lt;name&gt;_tfce_corrp_tstat2.nii.gz -l Blue-Lightblue -b 0.95,1</pre><span class="anchor" id="line-100"></span><ul><li><p class="line862">This command shows the outline of the structure in green overlaid on the MNI152 template. Significant positive changes (i.e. local enlargements) are red, negative ones are blue (assuming you specified the contrasts in such a way - adapt as needed). The volumes actually contain 1-p values, so a display range of 0.95 to 1 shows voxels that survive at p &lt;= 0.05 family-wise. <span class="anchor" id="line-101"></span></li></ul></ol><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2017-04-20 13:28
</body>
</html>
